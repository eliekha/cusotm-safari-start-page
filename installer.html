<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BriefDesk Setup</title>
<style>
:root {
  --text-primary: rgba(255,255,255,.95);
  --text-secondary: rgba(255,255,255,.75);
  --text-muted: rgba(255,255,255,.5);
  --bg-card: rgba(15,20,35,.65);
  --bg-card-solid: #1a1d2e;
  --border-color: rgba(255,255,255,.12);
  --border-hover: rgba(255,255,255,.22);
  --accent-blue: #4f8cff;
  --accent-green: #34d399;
  --accent-yellow: #fbbf24;
  --accent-red: #f87171;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  height: 100%;
  margin: 0;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
  background: #0f1219;
  min-height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  color: var(--text-primary);
  box-sizing: border-box;
}
.installer {
  background: var(--bg-card-solid);
  border-radius: 16px;
  border: 1px solid var(--border-color);
  width: 100%;
  max-width: 680px;
  position: relative;
  z-index: 1;
  box-shadow: 0 8px 32px rgba(0,0,0,.3);
}
.header {
  padding: 28px 28px 20px;
  border-bottom: 1px solid var(--border-color);
}
.header-title {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 6px;
}
.header-icon {
  width: 36px;
  height: 36px;
  background: rgba(79,140,255,.15);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.header-icon svg { width: 20px; height: 20px; fill: var(--accent-blue); }
.header h1 {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
}
.header p {
  font-size: 13px;
  color: var(--text-muted);
  margin-left: 48px;
}
.steps-nav {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px 28px;
  border-bottom: 1px solid var(--border-color);
  background: rgba(0,0,0,.15);
}
.step-indicator {
  display: flex;
  align-items: center;
  gap: 7px;
  font-size: 12px;
  color: var(--text-muted);
  white-space: nowrap;
}
.step-indicator.active { color: var(--text-primary); }
.step-indicator.completed { color: var(--accent-green); }
.step-num {
  width: 22px;
  height: 22px;
  border-radius: 6px;
  background: rgba(255,255,255,.08);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 600;
}
.step-indicator.active .step-num {
  background: var(--accent-blue);
  color: #fff;
}
.step-indicator.completed .step-num {
  background: var(--accent-green);
  color: #fff;
}
.step-indicator.completed .step-num svg { width: 12px; height: 12px; fill: #fff; }
.step-connector {
  width: 20px;
  height: 1px;
  background: var(--border-color);
  margin: 0 4px;
  align-self: center;
}
.content {
  padding: 24px 28px;
  min-height: 320px;
}
.step { display: none; }
.step.active { display: block; animation: fadeIn .2s ease; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
h2 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text-primary);
}
.step-desc {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 20px;
  line-height: 1.5;
}
.checklist {
  list-style: none;
}
.check-item {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  background: rgba(255,255,255,.04);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  margin-bottom: 10px;
}
.check-item.checking { background: rgba(251,191,36,.08); border-color: rgba(251,191,36,.2); }
.check-item.success { background: rgba(52,211,153,.08); border-color: rgba(52,211,153,.2); }
.check-item.error { background: rgba(248,113,113,.08); border-color: rgba(248,113,113,.2); }
.check-icon {
  width: 28px;
  height: 28px;
  border-radius: 7px;
  background: rgba(255,255,255,.08);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 14px;
  flex-shrink: 0;
}
.check-icon svg { width: 14px; height: 14px; fill: var(--text-muted); }
.check-item.checking .check-icon { background: rgba(251,191,36,.2); }
.check-item.checking .check-icon svg { fill: var(--accent-yellow); animation: pulse .8s ease infinite; }
.check-item.success .check-icon { background: rgba(52,211,153,.2); }
.check-item.success .check-icon svg { fill: var(--accent-green); }
.check-item.error .check-icon { background: rgba(248,113,113,.2); }
.check-item.error .check-icon svg { fill: var(--accent-red); }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }
.check-info { flex: 1; }
.check-name { font-size: 13px; font-weight: 500; color: var(--text-primary); }
.check-status { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.check-item.success .check-status { color: var(--accent-green); }
.check-item.error .check-status { color: var(--accent-red); }
.help-box {
  background: rgba(79,140,255,.08);
  border: 1px solid rgba(79,140,255,.2);
  border-radius: 10px;
  padding: 14px 16px;
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 16px;
  line-height: 1.5;
}
.help-box code {
  background: rgba(0,0,0,.3);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 11px;
}
.progress-section { margin: 20px 0; }
.progress-bar {
  height: 6px;
  background: rgba(255,255,255,.1);
  border-radius: 3px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: var(--accent-blue);
  border-radius: 3px;
  transition: width .4s ease;
  width: 0%;
}
.progress-label {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 10px;
  text-align: center;
}
.log-box {
  background: rgba(0,0,0,.3);
  border-radius: 8px;
  padding: 12px 14px;
  margin-top: 16px;
  max-height: 120px;
  overflow-y: auto;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 11px;
  color: var(--text-muted);
  line-height: 1.6;
}
.log-box .ok { color: var(--accent-green); }
.log-box .err { color: var(--accent-red); }
.log-box .info { color: var(--accent-blue); }
.integration-item {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  background: rgba(255,255,255,.04);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  margin-bottom: 10px;
  transition: border-color .2s;
}
.integration-item:hover { border-color: var(--border-hover); }
.integration-item.configured { border-color: rgba(52,211,153,.3); background: rgba(52,211,153,.05); }
.integration-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 14px;
  flex-shrink: 0;
  background: rgba(255,255,255,.06);
}
.integration-icon img { width: 26px; height: 26px; object-fit: contain; }
.integration-icon svg { width: 26px; height: 26px; }
.integration-info { flex: 1; }
.integration-name { font-size: 13px; font-weight: 500; color: var(--text-primary); }
.integration-status { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.integration-item.configured .integration-status { color: var(--accent-green); }
.integration-action {
  padding: 7px 14px;
  background: rgba(255,255,255,.08);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-secondary);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all .15s;
}
.integration-action:hover { background: rgba(255,255,255,.12); color: var(--text-primary); }
.skip-link {
  display: block;
  text-align: center;
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 16px;
  cursor: pointer;
}
.skip-link:hover { color: var(--text-secondary); }
.complete-section { text-align: center; padding: 20px 0; }
.complete-icon {
  width: 56px;
  height: 56px;
  background: rgba(52,211,153,.15);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
}
.complete-icon svg { width: 28px; height: 28px; fill: var(--accent-green); }
.complete-url {
  background: rgba(0,0,0,.3);
  border-radius: 8px;
  padding: 14px 18px;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 13px;
  color: var(--accent-blue);
  margin: 16px 0;
}
.footer {
  padding: 16px 28px;
  border-top: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  background: rgba(0,0,0,.1);
}
.btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  border: none;
  transition: all .15s;
  font-family: inherit;
}
.btn-secondary {
  background: rgba(255,255,255,.08);
  color: var(--text-secondary);
  border: 1px solid var(--border-color);
}
.btn-secondary:hover { background: rgba(255,255,255,.12); color: var(--text-primary); }
.btn-primary {
  background: var(--accent-blue);
  color: #fff;
}
.btn-primary:hover { background: #3d7ae8; }
.btn-primary:disabled { background: rgba(255,255,255,.1); color: var(--text-muted); cursor: not-allowed; }
.btn-success { background: var(--accent-green); color: #0f172a; }
.btn-success:hover { background: #2bc48a; }

/* Google Sign-In Image Button */
.google-signin-btn {
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
  display: inline-block;
}
.google-signin-btn img {
  display: block;
  border-radius: 4px;
}
.google-signin-btn:hover {
  opacity: 0.9;
}
.google-signin-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Google Sign-In Button (legacy) */
.gsi-material-button {
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
  -webkit-appearance: none;
  background-color: #fff;
  background-image: none;
  border: 1px solid #dadce0;
  border-radius: 8px;
  box-sizing: border-box;
  color: #3c4043;
  cursor: pointer;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
  font-size: 14px;
  font-weight: 500;
  height: 44px;
  letter-spacing: 0.25px;
  outline: none;
  overflow: hidden;
  padding: 0 16px;
  position: relative;
  text-align: center;
  transition: background-color .218s, border-color .218s, box-shadow .218s;
  vertical-align: middle;
  white-space: nowrap;
  width: 100%;
}
.gsi-material-button .gsi-material-button-icon {
  height: 20px;
  margin-right: 10px;
  min-width: 20px;
  width: 20px;
}
.gsi-material-button .gsi-material-button-content-wrapper {
  align-items: center;
  display: flex;
  flex-direction: row;
  flex-wrap: nowrap;
  height: 100%;
  justify-content: center;
  position: relative;
  width: 100%;
}
.gsi-material-button .gsi-material-button-contents {
  flex-grow: 0;
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  vertical-align: top;
}
.gsi-material-button .gsi-material-button-state {
  transition: opacity .218s;
  bottom: 0;
  left: 0;
  opacity: 0;
  position: absolute;
  right: 0;
  top: 0;
}
.gsi-material-button:not(:disabled):active .gsi-material-button-state,
.gsi-material-button:not(:disabled):focus .gsi-material-button-state {
  background-color: #303030;
  opacity: 12%;
}
.gsi-material-button:not(:disabled):hover {
  box-shadow: 0 1px 2px 0 rgba(60, 64, 67, .30), 0 1px 3px 1px rgba(60, 64, 67, .15);
}
.gsi-material-button:not(:disabled):hover .gsi-material-button-state {
  background-color: #303030;
  opacity: 8%;
}

/* Atlassian Button */
.atlassian-button {
  background-color: #0052CC;
  border: none;
  border-radius: 8px;
  color: #fff;
  cursor: pointer;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
  font-size: 14px;
  font-weight: 500;
  height: 44px;
  padding: 0 16px;
  width: 100%;
  transition: background-color .218s, box-shadow .218s;
}
.atlassian-button .gsi-material-button-content-wrapper {
  align-items: center;
  display: flex;
  flex-direction: row;
  justify-content: center;
  height: 100%;
}
.atlassian-button .gsi-material-button-icon {
  height: 20px;
  margin-right: 10px;
  min-width: 20px;
  width: 20px;
}
.atlassian-button .gsi-material-button-icon img {
  filter: brightness(0) invert(1);
  width: 100%;
  height: 100%;
}
.atlassian-button:hover {
  background-color: #0065FF;
  box-shadow: 0 1px 2px 0 rgba(60, 64, 67, .30), 0 1px 3px 1px rgba(60, 64, 67, .15);
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 100;
}
.modal.show { display: flex; align-items: center; justify-content: center; }
.modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.6);
  backdrop-filter: blur(4px);
}
.modal-content {
  position: relative;
  background: var(--bg-card-solid);
  border-radius: 12px;
  border: 1px solid var(--border-color);
  padding: 24px;
  max-width: 440px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}
.modal-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}
.modal-header h3 { font-size: 16px; font-weight: 600; }
.modal-close {
  margin-left: auto;
  width: 28px;
  height: 28px;
  background: rgba(255,255,255,.08);
  border: none;
  border-radius: 6px;
  color: var(--text-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.modal-close:hover { background: rgba(255,255,255,.12); color: var(--text-primary); }
.modal-close svg { width: 16px; height: 16px; }
.setup-steps {
  list-style: none;
  counter-reset: step;
}
.setup-steps li {
  counter-increment: step;
  padding: 12px 0 12px 36px;
  position: relative;
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
  border-bottom: 1px solid var(--border-color);
}
.setup-steps li:last-child { border-bottom: none; }
.setup-steps li::before {
  content: counter(step);
  position: absolute;
  left: 0;
  top: 12px;
  width: 22px;
  height: 22px;
  background: rgba(79,140,255,.2);
  color: var(--accent-blue);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 600;
}
.setup-steps code {
  display: block;
  background: rgba(0,0,0,.3);
  padding: 8px 10px;
  border-radius: 6px;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 10px;
  margin-top: 8px;
  overflow-x: auto;
  color: var(--text-muted);
}
.copyable {
  display: flex;
  align-items: stretch;
  margin-top: 8px;
  border-radius: 8px;
  overflow: hidden;
  background: rgba(0,0,0,.4);
  border: 1px solid rgba(255,255,255,.08);
}
.copyable code {
  flex: 1;
  display: block;
  padding: 10px 14px;
  font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
  font-size: 12px;
  color: #a5d6ff;
  word-break: break-all;
  white-space: pre-wrap;
  background: transparent;
  margin: 0;
  overflow-x: auto;
}
.copy-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  padding: 0 12px;
  background: rgba(255,255,255,.06);
  border: none;
  border-left: 1px solid rgba(255,255,255,.1);
  font-size: 11px;
  font-weight: 500;
  color: var(--text-muted);
  cursor: pointer;
  transition: all .15s ease;
  white-space: nowrap;
}
.copy-btn:hover { background: rgba(255,255,255,.12); color: var(--text-primary); }
.copy-btn svg { width: 14px; height: 14px; flex-shrink: 0; }
.copy-btn.copied { background: rgba(52,211,153,.15); color: var(--accent-green); }
.input-group { margin-top: 16px; }
.input-group label {
  display: block;
  font-size: 11px;
  font-weight: 500;
  color: var(--text-muted);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: .5px;
}
.input-group input {
  width: 100%;
  padding: 10px 12px;
  background: rgba(255,255,255,.06);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: 'SF Mono', Monaco, monospace;
}
.input-group input:focus { outline: none; border-color: var(--accent-blue); }
.modal-result {
  margin-top: 12px;
  padding: 10px 12px;
  border-radius: 6px;
  font-size: 12px;
}
.modal-result.success { background: rgba(52,211,153,.1); color: var(--accent-green); }
.modal-result.error { background: rgba(248,113,113,.1); color: var(--accent-red); }
.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.modal-actions .btn { flex: 1; }

/* Browser tabs */
#browser-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}
.browser-tab {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 16px;
  background: rgba(255,255,255,.04);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all .15s;
}
.browser-tab:hover {
  background: rgba(255,255,255,.08);
  border-color: var(--border-hover);
}
.browser-tab.active {
  background: rgba(79,140,255,.15);
  border-color: var(--accent-blue);
  color: var(--text-primary);
}
.browser-tab img {
  width: 20px;
  height: 20px;
  object-fit: contain;
}

/* Server Error Overlay */
.server-error {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,.9);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.server-error-content {
  background: var(--surface);
  border-radius: 12px;
  padding: 32px;
  max-width: 480px;
  text-align: center;
  border: 1px solid var(--border);
}
.server-error-content h3 {
  margin: 16px 0 8px;
  font-size: 20px;
  color: #f59e0b;
}
.server-error-content p {
  color: var(--text-secondary);
  margin: 0;
  font-size: 14px;
}
.server-error-content ul {
  text-align: left;
  margin: 12px 0;
  padding-left: 20px;
  color: var(--text-secondary);
  font-size: 13px;
}
.server-error-content li {
  margin: 6px 0;
}

/* FDA all-granted banner */
/* FDA styles removed - FDA step eliminated */
</style>
</head>
<body>

<div class="installer">
  <div class="header">
    <div class="header-title">
      <div class="header-icon">
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
      </div>
      <h1>BriefDesk Setup</h1>
    </div>
    <p>Configure your productivity dashboard</p>
  </div>
  
  <div class="steps-nav">
    <div class="step-indicator active" data-step="1">
      <div class="step-num">1</div>
      <span>Status</span>
    </div>
    <div class="step-connector"></div>
    <div class="step-indicator" data-step="2">
      <div class="step-num">2</div>
      <span>Connect</span>
    </div>
    <div class="step-connector"></div>
    <div class="step-indicator" data-step="3">
      <div class="step-num">3</div>
      <span>Done</span>
    </div>
  </div>
  
  <div class="content">
    <!-- Step 1: Welcome & Status -->
    <div class="step active" id="step-1">
      <h2>BriefDesk is Ready</h2>
      <p class="step-desc">Everything has been set up by the installer. Here's what's running:</p>
      
      <ul class="checklist" id="system-info-list">
        <li class="check-item checking" id="si-python">
          <div class="check-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg></div>
          <div class="check-info">
            <div class="check-name">Python</div>
            <div class="check-status">Checking...</div>
          </div>
        </li>
        <li class="check-item checking" id="si-node">
          <div class="check-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg></div>
          <div class="check-info">
            <div class="check-name">Node.js</div>
            <div class="check-status">Checking...</div>
          </div>
        </li>
        <li class="check-item checking" id="si-services">
          <div class="check-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg></div>
          <div class="check-info">
            <div class="check-name">Background Services</div>
            <div class="check-status">Checking...</div>
          </div>
        </li>
        <li class="check-item checking" id="si-devsai">
          <div class="check-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg></div>
          <div class="check-info">
            <div class="check-name">DevsAI CLI</div>
            <div class="check-status">Checking...</div>
          </div>
        </li>
        <li class="check-item checking" id="si-github">
          <div class="check-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg></div>
          <div class="check-info">
            <div class="check-name">GitHub MCP</div>
            <div class="check-status">Checking...</div>
          </div>
        </li>
      </ul>
    </div>
    
    <!-- Step 2: Connect Services -->
    <div class="step" id="step-2">
      <h2>Connect Services</h2>
      <p class="step-desc">Configure the integrations you want to use. You can always set these up later from Settings.</p>
      
      <div class="integration-item" id="int-calendar">
        <div class="integration-icon">
          <img src="icons/calendar.png" alt="Google Calendar">
        </div>
        <div class="integration-info">
          <div class="integration-name">Google Calendar</div>
          <div class="integration-status" id="calendar-status">Not configured</div>
        </div>
        <button class="integration-action" onclick="showCalendarSetup()">Setup</button>
      </div>
      
      <div class="integration-item" id="int-slack">
        <div class="integration-icon">
          <img src="icons/slack.png" alt="Slack">
        </div>
        <div class="integration-info">
          <div class="integration-name">Slack</div>
          <div class="integration-status" id="slack-status">Not configured</div>
        </div>
        <button class="integration-action" onclick="showSlackSetup()">Setup</button>
      </div>
      
      <div class="integration-item" id="int-gmail">
        <div class="integration-icon">
          <img src="icons/gmail.png" alt="Gmail">
        </div>
        <div class="integration-info">
          <div class="integration-name">Gmail</div>
          <div class="integration-status" id="gmail-status">Not configured</div>
        </div>
        <button class="integration-action" onclick="showGmailSetup()">Setup</button>
      </div>
      
      <div class="integration-item" id="int-atlassian">
        <div class="integration-icon">
          <img src="icons/jira.svg" alt="Atlassian">
        </div>
        <div class="integration-info">
          <div class="integration-name">Atlassian (Jira & Confluence)</div>
          <div class="integration-status" id="atlassian-status">Not configured</div>
        </div>
        <button class="integration-action" onclick="showAtlassianSetup()">Setup</button>
      </div>
      
      <div class="integration-item" id="int-drive">
        <div class="integration-icon">
          <img src="icons/drive.png" alt="Google Drive">
        </div>
        <div class="integration-info">
          <div class="integration-name">Google Drive</div>
          <div class="integration-status" id="drive-status">Not configured</div>
        </div>
        <button class="integration-action" onclick="showDriveSetup()">Setup</button>
      </div>

      <div class="integration-item" id="int-github">
        <div class="integration-icon">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
        </div>
        <div class="integration-info">
          <div class="integration-name">GitHub</div>
          <div class="integration-status" id="github-status">Not configured</div>
        </div>
        <button class="integration-action" onclick="showGithubSetup()">Setup</button>
      </div>

      <div class="integration-item" id="int-devsai">
        <div class="integration-icon" style="font-weight:600;color:#e0e0e0;">AI</div>
        <div class="integration-info">
          <div class="integration-name">Devs.ai (Search Service)</div>
          <div class="integration-status" id="devsai-status">Checking...</div>
        </div>
        <button class="integration-action" onclick="showDevsaiSetup()">Setup</button>
      </div>
      
      <span class="skip-link" onclick="goToStep(3)">Skip for now, configure later</span>
    </div>
    
    <!-- Step 3: You're All Set -->
    <div class="step" id="step-3">
      <div class="complete-section">
        <div class="complete-icon">
          <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        </div>
        <h2>You're All Set!</h2>
        <p class="step-desc">BriefDesk is installed and running. Set this as your browser homepage for quick access.</p>
        <div class="complete-url">http://127.0.0.1:8765/start.html</div>
      </div>
      
      <div id="browser-setup-section" style="margin-top:20px;">
        <!-- Chrome Instructions -->
        <div class="browser-content" id="browser-chrome" style="display:none;">
          <div class="help-box" style="margin-top:0;">
            <strong>Load BriefDesk New Tab Extension</strong><br><br>
            1. Copy the extension folder path:<br>
            <div class="copyable" style="margin:8px 0;">
              <code id="chrome-ext-path">~/.local/share/briefdesk/browser-extension/chrome</code>
              <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
            </div>
            2. Open <strong>chrome://extensions</strong> in Chrome<br>
            3. Enable <strong>Developer Mode</strong> (toggle in the top-right)<br>
            4. Click <strong>"Load unpacked"</strong><br>
            5. Press <strong>Cmd+Shift+G</strong>, paste the path, and select the folder<br>
            6. Open a new tab to verify it works
          </div>
          <button class="btn btn-primary" onclick="copyExtPath('chrome')" style="width:100%;margin-top:12px;">
            Copy Extension Path
          </button>
        </div>
        
        <!-- Firefox Instructions -->
        <div class="browser-content" id="browser-firefox" style="display:none;">
          <div class="help-box" style="margin-top:0;">
            <strong>Load BriefDesk New Tab Extension</strong><br><br>
            The extension may have been auto-installed during setup. If not:<br><br>
            1. Copy the extension folder path:<br>
            <div class="copyable" style="margin:8px 0;">
              <code id="firefox-ext-path">~/.local/share/briefdesk/browser-extension/firefox</code>
              <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
            </div>
            2. Open <strong>about:debugging#/runtime/this-firefox</strong> in Firefox<br>
            3. Click <strong>"Load Temporary Add-on..."</strong><br>
            4. Navigate to the path above and select <strong>manifest.json</strong><br>
            5. Open a new tab to verify it works<br><br>
            <em style="color:var(--text-muted);">Note: Temporary add-ons persist until Firefox is restarted. For permanent install, restart Firefox and the extension should load automatically.</em>
          </div>
          <button class="btn btn-primary" onclick="copyExtPath('firefox')" style="width:100%;margin-top:12px;">
            Copy Extension Path
          </button>
        </div>
        
        <!-- Safari Instructions -->
        <div class="browser-content" id="browser-safari" style="display:none;">
          <div class="help-box" style="margin-top:0;">
            <strong>Set Homepage in Safari</strong><br><br>
            Safari doesn't support new tab redirect extensions, but you can set BriefDesk as your homepage:<br><br>
            1. Open <strong>Safari → Settings</strong> (or press <strong>Cmd+,</strong>)<br>
            2. Go to the <strong>General</strong> tab<br>
            3. Set "Homepage" to:
            <div class="copyable" style="margin:12px 0 8px;">
              <code>http://127.0.0.1:8765/start.html</code>
              <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
            </div>
            4. Set "New windows open with" and "New tabs open with" to <strong>Homepage</strong><br><br>
            <em style="color:var(--text-muted);">Tip: Press <strong>Cmd+Shift+H</strong> anytime to go to your homepage.</em>
          </div>
          <button class="btn btn-secondary" onclick="openSafariSettings()" style="width:100%;margin-top:12px;">
            Open Safari Settings
          </button>
        </div>
      </div>
      
      <p class="step-desc" style="font-size:12px;text-align:center;margin-top:16px;">You can configure more integrations anytime from the Settings panel.</p>
    </div>
  </div>
  
  <div class="footer">
    <button class="btn btn-secondary" id="btn-back" onclick="prevStep()" style="visibility:hidden;">Back</button>
    <button class="btn btn-primary" id="btn-next" onclick="nextStep()">Continue</button>
  </div>
</div>

<!-- Slack Setup Modal -->
<div class="modal" id="slack-modal">
  <div class="modal-backdrop" onclick="closeSlackModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <img src="icons/slack.png" alt="Slack" width="24" height="24">
      <h3>Connect Slack</h3>
      <button class="modal-close" onclick="closeSlackModal()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>
    
      <div class="help-box" style="margin-bottom:16px;background:rgba(52,211,153,.1);border-color:rgba(52,211,153,.3);">
      <strong>Quick Setup</strong><br>
      If you're logged into Slack in Chrome or Safari, we can try to auto-detect your credentials.<br><br>
      <button class="btn btn-primary" onclick="autoDetectSlack()" id="slack-auto-detect-btn" style="width:100%;">
        Auto-Detect from Browser
      </button>
      <div id="slack-auto-detect-result" style="margin-top:8px;font-size:12px;"></div>
    </div>
    
    <details style="margin-bottom:16px;">
      <summary style="cursor:pointer;color:var(--text-muted);font-size:13px;">Manual Setup Instructions</summary>
      <ol class="setup-steps" style="margin-top:12px;">
        <li>
          Open <a href="https://app.slack.com" target="_blank" style="color:var(--accent-blue)">app.slack.com</a> in your browser and sign in
        </li>
        <li>
          Open DevTools with <strong>Cmd+Option+I</strong>
        </li>
        <li>
          Go to Application → Cookies → copy the <strong>d</strong> cookie value (XOXD token)
        </li>
        <li>
          In Console tab, paste this to get the XOXC token:
          <div class="copyable">
            <code>JSON.parse(localStorage.getItem('localConfig_v2'))?.teams?.[Object.keys(JSON.parse(localStorage.getItem('localConfig_v2'))?.teams||{})[0]]?.token</code>
            <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
          </div>
        </li>
      </ol>
    </details>
    
    <div class="input-group">
      <label>XOXC Token</label>
      <input type="text" id="modal-slack-xoxc" placeholder="xoxc-...">
    </div>
    <div class="input-group">
      <label>XOXD Token</label>
      <input type="text" id="modal-slack-xoxd" placeholder="xoxd-...">
    </div>
    
    <div id="slack-modal-result"></div>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeSlackModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSlackTokens()">Save</button>
    </div>
  </div>
</div>

<!-- Google Services Setup Modal (Calendar, Drive, Gmail) -->
<div class="modal" id="calendar-modal">
  <div class="modal-backdrop" onclick="closeCalendarModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <img src="icons/calendar.png" alt="Google" width="24" height="24">
      <h3>Connect Google Services</h3>
      <button class="modal-close" onclick="closeCalendarModal()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>

    <div id="google-status-section" style="margin-bottom:16px;">
      <div id="google-connected" style="display:none;padding:12px;background:rgba(52,211,153,0.1);border-radius:8px;border:1px solid rgba(52,211,153,0.3);">
        <div style="display:flex;align-items:center;gap:8px;color:#34d399;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
          <strong>Connected to Google</strong>
        </div>
        <p style="margin:8px 0 0;font-size:12px;color:var(--text-secondary);">Calendar, Drive, and Gmail are ready to use.</p>
      </div>
      <div id="google-not-connected" style="display:none;padding:12px;background:rgba(251,191,36,0.1);border-radius:8px;border:1px solid rgba(251,191,36,0.3);">
        <div style="display:flex;align-items:center;gap:8px;color:#fbbf24;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
          <strong>Not connected</strong>
        </div>
      </div>
    </div>

    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">
      Connect your Google account to enable Calendar, Drive search, and Gmail integration. This grants read-only access.
    </p>

    <div style="display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:20px;">
      <button id="google-connect-btn" class="google-signin-btn" onclick="connectGoogle()">
        <img src="icons/google-signin.png" alt="Sign in with Google" height="40">
      </button>
      <button id="google-disconnect-btn" class="btn btn-secondary" onclick="disconnectGoogle()" style="display:none;">
        Disconnect Google Account
      </button>
    </div>

    <details style="margin-top:16px;">
      <summary style="color:var(--text-secondary);font-size:12px;cursor:pointer;">Advanced: Use your own credentials</summary>
      <ol class="setup-steps" style="margin-top:12px;font-size:12px;">
        <li>
          Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color:var(--accent-blue)">Google Cloud Console</a> and create an OAuth 2.0 Client ID (Desktop app)
        </li>
        <li>
          Enable APIs: <a href="https://console.cloud.google.com/apis/library/calendar-json.googleapis.com" target="_blank" style="color:var(--accent-blue)">Calendar</a>,
          <a href="https://console.cloud.google.com/apis/library/drive.googleapis.com" target="_blank" style="color:var(--accent-blue)">Drive</a>,
          <a href="https://console.cloud.google.com/apis/library/gmail.googleapis.com" target="_blank" style="color:var(--accent-blue)">Gmail</a>
        </li>
        <li>
          Download credentials JSON to: <code>~/.local/share/briefdesk/google_credentials.json</code>
        </li>
        <li>
          Run: <code>python3 ~/.local/share/briefdesk/search-server.py --auth</code>
        </li>
      </ol>
    </details>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeCalendarModal()">Close</button>
    </div>
  </div>
</div>

<!-- Gmail Setup Modal -->
<div class="modal" id="gmail-modal">
  <div class="modal-backdrop" onclick="closeGmailModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <img src="icons/gmail.png" alt="Gmail" width="24" height="24">
      <h3>Gmail</h3>
      <button class="modal-close" onclick="closeGmailModal()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>

    <div id="gmail-status-section">
      <div id="gmail-connected" style="display:none;padding:12px;background:rgba(52,211,153,0.1);border-radius:8px;border:1px solid rgba(52,211,153,0.3);">
        <div style="display:flex;align-items:center;gap:8px;color:#34d399;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
          <strong>Connected via Google</strong>
        </div>
        <p style="margin:8px 0 0;font-size:12px;color:var(--text-secondary);">Gmail is ready to use.</p>
      </div>
      <div id="gmail-not-connected" style="display:none;padding:12px;background:rgba(251,191,36,0.1);border-radius:8px;border:1px solid rgba(251,191,36,0.3);">
        <div style="display:flex;align-items:center;gap:8px;color:#fbbf24;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
          <strong>Not connected</strong>
        </div>
        <p style="margin:8px 0 0;font-size:12px;color:var(--text-secondary);">Connect Google via Calendar setup to enable Gmail.</p>
      </div>
    </div>

    <p style="color:var(--text-secondary);font-size:13px;margin:16px 0;">
      Connect your Gmail account to search emails during meeting prep. Uses read-only access for security.
    </p>

    <div style="display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:20px;">
      <button id="gmail-connect-btn" class="google-signin-btn" onclick="connectGmailMcp()">
        <img src="icons/google-signin.png" alt="Sign in with Google" height="40">
      </button>
      <button id="gmail-disconnect-btn" class="btn btn-secondary" onclick="disconnectGmailMcp(); closeGmailModal();" style="display:none;">
        Disconnect Gmail
      </button>
    </div>
    
    <div class="help-box" style="margin-top:12px;font-size:12px;">
      <strong>Security:</strong> Gmail uses read-only access - BriefDesk cannot send, modify, or delete your emails.
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeGmailModal()">Close</button>
    </div>
  </div>
</div>

<!-- Atlassian Setup Modal -->
<div class="modal" id="atlassian-modal">
  <div class="modal-backdrop" onclick="closeAtlassianModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <img src="icons/jira.svg" alt="Atlassian" width="24" height="24">
      <h3>Atlassian (Jira & Confluence)</h3>
      <button class="modal-close" onclick="closeAtlassianModal()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>

    <div id="atlassian-status-section" style="margin-bottom:16px;">
      <div id="atlassian-connected" style="display:none;padding:12px;background:rgba(52,211,153,0.1);border-radius:8px;border:1px solid rgba(52,211,153,0.3);">
        <div style="display:flex;align-items:center;gap:8px;color:#34d399;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
          <strong>Connected to Atlassian</strong>
        </div>
        <p style="margin:8px 0 0;font-size:12px;color:var(--text-secondary);">Jira and Confluence are ready to use.</p>
      </div>
      <div id="atlassian-not-connected" style="display:none;padding:12px;background:rgba(251,191,36,0.1);border-radius:8px;border:1px solid rgba(251,191,36,0.3);">
        <div style="display:flex;align-items:center;gap:8px;color:#fbbf24;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
          <strong>Not connected</strong>
        </div>
      </div>
    </div>

    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">
      Connect your Atlassian account to search Jira issues and Confluence pages.
    </p>

    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:20px;">
      <button id="atlassian-connect-btn" class="atlassian-button" onclick="connectAtlassian()">
        <div class="gsi-material-button-content-wrapper">
          <div class="gsi-material-button-icon">
            <img src="icons/jira.svg" alt="">
          </div>
          <span class="gsi-material-button-contents">Connect with Atlassian</span>
        </div>
      </button>
      <button id="atlassian-disconnect-btn" class="btn btn-secondary" onclick="disconnectAtlassian()" style="display:none;">
        Disconnect Atlassian
      </button>
    </div>

    <details style="margin-top:16px;">
      <summary style="color:var(--text-secondary);font-size:12px;cursor:pointer;">Manual setup (Terminal)</summary>
      <div style="margin-top:12px;">
        <p style="color:var(--text-muted);font-size:12px;margin-bottom:8px;">Run this command in Terminal:</p>
        <div class="copyable">
          <code>npx -y mcp-remote https://mcp.atlassian.com/v1/sse</code>
          <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
        </div>
      </div>
    </details>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeAtlassianModal()">Close</button>
    </div>
  </div>
</div>

<!-- Drive Setup Modal -->
<div class="modal" id="drive-modal">
  <div class="modal-backdrop" onclick="closeDriveModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <img src="icons/drive.png" alt="Drive" width="24" height="24">
      <h3>Google Drive</h3>
      <button class="modal-close" onclick="closeDriveModal()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>

    <div id="drive-status-section">
      <div id="drive-connected" style="display:none;padding:12px;background:rgba(52,211,153,0.1);border-radius:8px;border:1px solid rgba(52,211,153,0.3);">
        <div style="display:flex;align-items:center;gap:8px;color:#34d399;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
          <strong>Connected via Google</strong>
        </div>
        <p style="margin:8px 0 0;font-size:12px;color:var(--text-secondary);">Google Drive search is ready to use.</p>
      </div>
      <div id="drive-not-connected" style="display:none;padding:12px;background:rgba(251,191,36,0.1);border-radius:8px;border:1px solid rgba(251,191,36,0.3);">
        <div style="display:flex;align-items:center;gap:8px;color:#fbbf24;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
          <strong>Not connected</strong>
        </div>
        <p style="margin:8px 0 0;font-size:12px;color:var(--text-secondary);">Connect Google via Calendar setup to enable Drive search.</p>
      </div>
    </div>

    <p style="color:var(--text-secondary);font-size:13px;margin:16px 0;">
      Google Drive uses the same OAuth as Calendar and Gmail. Connect once to enable all three services with read-only access.
    </p>

    <div style="display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:20px;">
      <button id="drive-connect-btn" class="google-signin-btn" onclick="connectGoogle()">
        <img src="icons/google-signin.png" alt="Sign in with Google" height="40">
      </button>
      <button id="drive-disconnect-btn" class="btn btn-secondary" onclick="disconnectGoogle(); closeDriveModal();" style="display:none;">
        Disconnect Google Account
      </button>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeDriveModal()">Close</button>
    </div>
  </div>
</div>

<!-- DevsAI Setup Modal -->
<div class="modal" id="devsai-modal">
  <div class="modal-backdrop" onclick="closeDevsaiModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <div style="font-weight:600;color:#e0e0e0;">AI</div>
      <h3>Connect Devs.ai</h3>
      <button class="modal-close" onclick="closeDevsaiModal()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>
    <div class="help-box" style="margin-bottom:16px;">
      <strong>Status:</strong>
      <div id="devsai-modal-status" style="margin-top:6px;color:var(--text-muted);">Checking...</div>
      <div id="devsai-config-path" style="margin-top:6px;font-size:12px;color:var(--text-muted);"></div>
      <div id="devsai-login-result" style="margin-top:8px;font-size:12px;color:var(--text-muted);"></div>
    </div>
    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;">
      Click <strong>Start Login</strong> to open a browser window and authenticate. BriefDesk will handle the rest in the background.
    </p>
    <details style="margin-bottom:16px;">
      <summary style="cursor:pointer;color:var(--text-muted);font-size:13px;">Manual login (Terminal)</summary>
      <ol class="setup-steps" style="margin-top:12px;">
        <li>Open Terminal</li>
        <li>Run the command below to log in</li>
      </ol>
      <div class="copyable">
        <code>~/.local/bin/devsai login --no-repl</code>
        <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
      </div>
    </details>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeDevsaiModal()">Close</button>
      <button class="btn btn-secondary" onclick="checkDevsaiStatus()">Refresh Status</button>
      <button class="btn btn-primary" id="devsai-login-btn" onclick="startDevsaiLogin()">Start Login</button>
    </div>
  </div>
</div>

<!-- GitHub Setup Modal -->
<div class="modal" id="github-modal">
  <div class="modal-backdrop" onclick="closeGithubModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
      <h3>Connect GitHub</h3>
      <button class="modal-close" onclick="closeGithubModal()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>

    <div id="github-status-section" style="margin-bottom:16px;">
      <div id="github-connected" style="display:none;padding:12px;background:rgba(52,211,153,0.1);border-radius:8px;border:1px solid rgba(52,211,153,0.3);">
        <div style="display:flex;align-items:center;gap:8px;color:#34d399;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
          <strong>Connected to GitHub</strong>
        </div>
        <p style="margin:8px 0 0;font-size:12px;color:var(--text-secondary);">GitHub code search, issues, and PRs are ready.</p>
      </div>
      <div id="github-not-connected" style="display:none;padding:12px;background:rgba(251,191,36,0.1);border-radius:8px;border:1px solid rgba(251,191,36,0.3);">
        <div style="display:flex;align-items:center;gap:8px;color:#fbbf24;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
          <strong>Not connected</strong>
        </div>
      </div>
    </div>

    <!-- OAuth Flow (Primary) -->
    <div id="github-oauth-section">
      <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">
        Connect your GitHub account to search code, issues, and pull requests across your repositories and organizations.
      </p>

      <div id="github-oauth-start" style="text-align:center;padding:12px 0;">
        <button class="btn btn-primary" onclick="startGithubOAuth()" id="github-oauth-btn" style="display:inline-flex;align-items:center;gap:8px;padding:10px 24px;font-size:14px;">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
          Connect with GitHub
        </button>
      </div>

      <div id="github-oauth-code" style="display:none;text-align:center;padding:16px 0;">
        <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;">
          Enter this code on GitHub to authorize BriefDesk:
        </p>
        <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:12px;">
          <code id="github-device-code" style="font-size:28px;font-weight:700;letter-spacing:4px;padding:12px 20px;background:var(--bg-tertiary);border-radius:8px;border:1px solid var(--border-color);color:var(--text-primary);user-select:all;"></code>
          <button class="copy-btn" onclick="copyDeviceCode()" id="github-copy-code" style="padding:8px;border-radius:6px;background:var(--bg-secondary);border:1px solid var(--border-color);cursor:pointer;color:var(--text-muted);" title="Copy code">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
          </button>
        </div>
        <a id="github-verify-link" href="https://github.com/login/device" target="_blank" class="btn btn-secondary" style="display:inline-flex;align-items:center;gap:6px;font-size:13px;">
          <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M19 19H5V5h7V3H5a2 2 0 00-2 2v14a2 2 0 002 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
          Open GitHub to authorize
        </a>
        <p id="github-oauth-status" style="color:var(--text-muted);font-size:12px;margin-top:12px;">Waiting for authorization...</p>
      </div>
    </div>

    <div id="github-modal-result"></div>

    <!-- PAT Fallback (Secondary) -->
    <div style="margin-top:12px;border-top:1px solid var(--border-color);padding-top:12px;">
      <button onclick="toggleGithubPat()" style="background:none;border:none;color:var(--text-muted);font-size:12px;cursor:pointer;padding:0;display:flex;align-items:center;gap:4px;" id="github-pat-toggle">
        <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor" id="github-pat-arrow" style="transition:transform .2s;"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
        Or use a Personal Access Token
      </button>
      <div id="github-pat-section" style="display:none;margin-top:12px;">
        <ol class="setup-steps" style="font-size:12px;">
          <li>Go to <a href="https://github.com/settings/tokens?type=beta" target="_blank" style="color:var(--accent-blue)">GitHub Token Settings</a> and click <strong>Generate new token</strong></li>
          <li>Grant: <strong>Contents</strong> (read), <strong>Issues</strong> (read), <strong>Pull requests</strong> (read), <strong>Metadata</strong> (read)</li>
          <li>Copy the token and paste it below</li>
        </ol>
        <div class="input-group">
          <label>Personal Access Token</label>
          <input type="password" id="modal-github-pat" placeholder="github_pat_...">
        </div>
        <div style="margin-top:8px;">
          <button class="btn btn-primary" onclick="saveGithubPat()" style="font-size:13px;">Save & Connect</button>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeGithubModal()">Close</button>
    </div>
  </div>
</div>

<!-- Server Error Overlay -->
<div id="server-error" class="server-error" style="display:none;">
  <div class="server-error-content">
    <svg viewBox="0 0 24 24" width="48" height="48" fill="#f59e0b"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
    <h3>Server Not Running</h3>
    <p>The BriefDesk server isn't responding. This can happen if:</p>
    <ul>
      <li>The server hasn't started yet (wait a few seconds)</li>
      <li>The server crashed or was stopped</li>
      <li>Another app is using port 18765</li>
    </ul>
    <p style="margin-top:16px;font-size:12px;color:var(--text-muted);">Try restarting the server manually:</p>
    <div class="copyable" style="margin:8px 0;">
      <code>launchctl kickstart -k gui/$(id -u)/com.briefdesk.server</code>
      <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
    </div>
    <button class="btn btn-primary" onclick="checkServerConnection()" style="margin-top:16px;">Retry Connection</button>
  </div>
</div>

<script>
const API = 'http://127.0.0.1:18765';
const SEARCH_SERVICE = 'http://127.0.0.1:19765';
let currentStep = 1;
let serverConnected = false;
let systemInfo = null;
// fdaPollInterval removed - FDA step eliminated

// ─── Server Connection ───────────────────────────────────────────────

async function checkServerConnection() {
  const errorEl = document.getElementById('server-error');
  try {
    const res = await fetch(API + '/hub/status', { signal: AbortSignal.timeout(5000) });
    if (res.ok) {
      serverConnected = true;
      errorEl.style.display = 'none';
      return true;
    }
  } catch (e) {
    console.error('Server connection failed:', e);
  }
  serverConnected = false;
  errorEl.style.display = 'flex';
  return false;
}

// Check on page load
setTimeout(checkServerConnection, 500);

// ─── Clipboard ───────────────────────────────────────────────────────

function copyText(btn) {
  const code = btn.parentElement.querySelector('code');
  const text = code.textContent;
  navigator.clipboard.writeText(text).then(() => {
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Copied';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy';
      btn.classList.remove('copied');
    }, 2000);
  });
}

// ─── Step Navigation ─────────────────────────────────────────────────

const SVG_CHECK = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
const SVG_CIRCLE = '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg>';
const SVG_X = '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>';

function updateUI() {
  // Update step indicators
  document.querySelectorAll('.step-indicator').forEach((el, i) => {
    el.classList.remove('active', 'completed');
    const step = i + 1;
    if (step === currentStep) el.classList.add('active');
    else if (step < currentStep) {
      el.classList.add('completed');
      el.querySelector('.step-num').innerHTML = SVG_CHECK;
    }
  });
  
  // Update step content
  document.querySelectorAll('.step').forEach((el, i) => {
    el.classList.toggle('active', i + 1 === currentStep);
  });
  
  // Update buttons
  document.getElementById('btn-back').style.visibility = currentStep > 1 ? 'visible' : 'hidden';
  const nextBtn = document.getElementById('btn-next');
  
  if (currentStep === 1) {
    nextBtn.textContent = 'Continue';
    nextBtn.disabled = false;
    nextBtn.className = 'btn btn-primary';
  } else if (currentStep === 2) {
    nextBtn.textContent = 'Continue';
    nextBtn.disabled = false;
    nextBtn.className = 'btn btn-primary';
  } else if (currentStep === 3) {
    nextBtn.textContent = 'Open BriefDesk';
    nextBtn.disabled = false;
    nextBtn.className = 'btn btn-success';
  }
}

function goToStep(step) {
  currentStep = step;
  updateUI();
  if (step === 1) loadSystemInfo();
  if (step === 2) checkIntegrations();
  if (step === 3) setupBrowserInstructions();
}

function nextStep() {
  if (currentStep === 3) {
    window.open('http://127.0.0.1:8765/start.html', '_blank');
    return;
  }
  goToStep(currentStep + 1);
}

function prevStep() {
  if (currentStep > 1) goToStep(currentStep - 1);
}

// ─── Step 1: System Info ─────────────────────────────────────────────

function setCheckItem(id, state, statusText) {
  const el = document.getElementById(id);
  if (!el) return;
  const icon = el.querySelector('.check-icon');
  const status = el.querySelector('.check-status');
  el.className = 'check-item ' + state;
  if (state === 'success') {
    icon.innerHTML = SVG_CHECK;
  } else if (state === 'error') {
    icon.innerHTML = SVG_X;
  } else if (state === 'checking') {
    icon.innerHTML = SVG_CIRCLE;
  } else {
    icon.innerHTML = SVG_CIRCLE;
  }
  status.textContent = statusText;
}

async function loadSystemInfo() {
  // Set all to checking state
  ['si-python', 'si-node', 'si-services', 'si-devsai', 'si-github'].forEach(id => {
    setCheckItem(id, 'checking', 'Checking...');
  });

  try {
    const res = await fetch(API + '/installer/system-info', { signal: AbortSignal.timeout(8000) });
    const data = await res.json();
    systemInfo = data;

    // Python
    if (data.python_version) {
      setCheckItem('si-python', 'success', data.python_version);
    } else {
      setCheckItem('si-python', 'error', 'Not found');
    }

    // Node.js
    if (data.node_version) {
      const nodeLabel = data.node_source === 'downloaded' 
        ? data.node_version + ' (auto-downloaded)' 
        : data.node_version;
      setCheckItem('si-node', 'success', nodeLabel);
    } else {
      setCheckItem('si-node', 'error', 'Not found');
    }

    // Background Services - if we got a response, the server is running
    setCheckItem('si-services', 'success', 'Running');

    // DevsAI CLI - check auth via search service
    if (data.devsai_installed) {
      setCheckItem('si-devsai', 'checking', 'Checking login...');
      try {
        const devsaiRes = await fetch(SEARCH_SERVICE + '/devsai/status', { signal: AbortSignal.timeout(5000) });
        const devsaiData = await devsaiRes.json();
        if (devsaiData.authenticated) {
          const label = devsaiData.userEmail ? 'Logged in as ' + devsaiData.userEmail : 'Logged in';
          setCheckItem('si-devsai', 'success', label);
        } else {
          setCheckItem('si-devsai', 'checking', 'Installed, not logged in');
        }
      } catch (e) {
        setCheckItem('si-devsai', 'checking', 'Installed (status unavailable)');
      }
    } else {
      setCheckItem('si-devsai', 'checking', 'Not installed');
    }

    // GitHub MCP
    if (data.github_mcp_installed) {
      setCheckItem('si-github', 'success', 'Binary installed');
    } else {
      setCheckItem('si-github', 'checking', 'Not installed');
    }

    // Store Python path for potential Settings use
    // (FDA step removed -- Safari history is opt-in via Settings)

    // Auto-advance to Step 2 (Connect) if all core checks pass
    const pythonOk = !!data.python_version;
    const nodeOk = !!data.node_version;
    const servicesOk = true; // If we got here, the server responded
    if (pythonOk && nodeOk && servicesOk) {
      setTimeout(() => {
        if (currentStep === 1) goToStep(2);
      }, 2000);
    }

  } catch (e) {
    console.error('Failed to load system info:', e);
    // Server is running (we checked earlier), mark services as running
    setCheckItem('si-services', 'success', 'Running');
    setCheckItem('si-python', 'checking', 'Unable to verify');
    setCheckItem('si-node', 'checking', 'Unable to verify');
    setCheckItem('si-devsai', 'checking', 'Unable to verify');
    setCheckItem('si-github', 'checking', 'Unable to verify');
  }
}

// ─── Step 2: Integrations ────────────────────────────────────────────

async function checkIntegrations() {
  try {
    const res = await fetch(API + '/hub/status');
    const data = await res.json();
    
    if (data.calendar?.authenticated) {
      document.getElementById('int-calendar').classList.add('configured');
      document.getElementById('calendar-status').textContent = 'Connected';
    }
    
    if (data.slack?.authenticated) {
      document.getElementById('int-slack').classList.add('configured');
      document.getElementById('slack-status').textContent = 'Connected';
    }
    
    if (data.gmail?.authenticated) {
      document.getElementById('int-gmail').classList.add('configured');
      document.getElementById('gmail-status').textContent = 'Connected';
    }
    
    if (data.atlassian?.authenticated) {
      document.getElementById('int-atlassian').classList.add('configured');
      document.getElementById('atlassian-status').textContent = 'Connected';
    }
    
    if (data.drive?.authenticated) {
      document.getElementById('int-drive').classList.add('configured');
      document.getElementById('drive-status').textContent = 'Connected';
    }
    
    if (data.github?.authenticated) {
      document.getElementById('int-github').classList.add('configured');
      document.getElementById('github-status').textContent = 'Connected';
    }
  } catch (e) {
    console.error('Failed to check integrations:', e);
  }

  // Also check GitHub via search service directly (more accurate)
  checkGithubStatus();

  // DevsAI status (handled via search-service)
  checkDevsaiStatus();
}

// ─── Step 3: Browser Setup ───────────────────────────────────────────

function detectBrowser() {
  const ua = navigator.userAgent;
  if (ua.includes('Chrome') && !ua.includes('Edg')) return 'chrome';
  if (ua.includes('Firefox')) return 'firefox';
  if (ua.includes('Safari') && !ua.includes('Chrome')) return 'safari';
  return 'chrome'; // default
}

function setupBrowserInstructions() {
  const browser = detectBrowser();
  // Hide all browser contents
  document.querySelectorAll('.browser-content').forEach(el => {
    el.style.display = 'none';
  });
  // Show only the detected browser
  const target = document.getElementById('browser-' + browser);
  if (target) target.style.display = 'block';
  
  // Expand ~ to actual install path if available from system info
  if (systemInfo && systemInfo.install_dir) {
    const installDir = systemInfo.install_dir;
    const chromePathEl = document.getElementById('chrome-ext-path');
    const firefoxPathEl = document.getElementById('firefox-ext-path');
    if (chromePathEl) chromePathEl.textContent = installDir + '/browser-extension/chrome';
    if (firefoxPathEl) firefoxPathEl.textContent = installDir + '/browser-extension/firefox';
  }
}

function copyExtPath(browser) {
  const el = document.getElementById(browser + '-ext-path');
  if (el) {
    navigator.clipboard.writeText(el.textContent).then(() => {
      const btn = el.closest('.browser-content').querySelector('.btn-primary');
      if (btn) {
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        btn.style.background = 'var(--green)';
        setTimeout(() => { btn.textContent = orig; btn.style.background = ''; }, 2000);
      }
    });
  }
}

function openSafariSettings() {
  window.location.href = 'x-apple.systempreferences:com.apple.Safari';
}

// ─── Slack ───────────────────────────────────────────────────────────

function showSlackSetup() { document.getElementById('slack-modal').classList.add('show'); }
function closeSlackModal() { document.getElementById('slack-modal').classList.remove('show'); }

async function autoDetectSlack() {
  const btn = document.getElementById('slack-auto-detect-btn');
  const resultEl = document.getElementById('slack-auto-detect-result');
  const xoxcInput = document.getElementById('modal-slack-xoxc');
  const xoxdInput = document.getElementById('modal-slack-xoxd');
  
  btn.disabled = true;
  btn.textContent = 'Detecting...';
  resultEl.innerHTML = '<span style="color:var(--accent-blue)">Reading browser data...</span>';
  
  try {
    const res = await fetch(API + '/slack/auto-detect');
    const data = await res.json();
    
    if (data.success) {
      if (data.xoxc) xoxcInput.value = data.xoxc;
      if (data.xoxd) xoxdInput.value = data.xoxd;
      
      if (data.partial) {
        let instructions = '';
        if (!data.xoxd && data.xoxc) {
          instructions = '<br><br><strong>To get the missing xoxd token:</strong><br>' +
            '1. Open DevTools in ' + (data.browser || 'your browser') + ' (Cmd+Option+I)<br>' +
            '2. Go to <strong>Application</strong> → <strong>Cookies</strong> → slack.com<br>' +
            '3. Find cookie named "<strong>d</strong>" (starts with xoxd-)<br>' +
            '4. Copy the value and paste in the field below';
        } else if (data.xoxd && !data.xoxc) {
          instructions = '<br><br><strong>To get the missing xoxc token:</strong><br>' +
            '1. Open DevTools in ' + (data.browser || 'your browser') + ' (Cmd+Option+I)<br>' +
            '2. Go to <strong>Application</strong> → <strong>Local Storage</strong> → slack.com<br>' +
            '3. Find the key containing "xoxc-"<br>' +
            '4. Copy the value and paste in the field below';
        }
        resultEl.innerHTML = '<span style="color:var(--accent-yellow)">⚠️ ' + data.message + '</span>' + instructions;
      } else {
        resultEl.innerHTML = '<span style="color:var(--accent-green)">✓ ' + data.message + '</span>';
      }
    } else {
      resultEl.innerHTML = '<span style="color:var(--accent-red)">✗ ' + data.error + '</span>';
    }
  } catch (e) {
    resultEl.innerHTML = '<span style="color:var(--accent-red)">✗ Failed to detect: ' + e.message + '</span>';
  }
  
  btn.disabled = false;
  btn.textContent = 'Auto-Detect from Browser';
}

async function saveSlackTokens() {
  const xoxc = document.getElementById('modal-slack-xoxc').value.trim();
  const xoxd = document.getElementById('modal-slack-xoxd').value.trim();
  const result = document.getElementById('slack-modal-result');
  
  if (!xoxc || !xoxd) {
    result.innerHTML = '<div class="modal-result error">Please enter both tokens</div>';
    return;
  }
  
  result.innerHTML = '<div class="modal-result" style="background:rgba(79,140,255,.1);color:var(--accent-blue)">Saving...</div>';
  
  try {
    const res = await fetch(API + '/setup/slack', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ xoxc, xoxd })
    });
    const data = await res.json();
    
    if (data.success) {
      result.innerHTML = '<div class="modal-result success">Connected successfully</div>';
      setTimeout(() => { closeSlackModal(); checkIntegrations(); }, 1000);
    } else {
      result.innerHTML = '<div class="modal-result error">' + (data.error || 'Failed to connect') + '</div>';
    }
  } catch (e) {
    result.innerHTML = '<div class="modal-result error">Connection failed</div>';
  }
}

// ─── Google Calendar / Drive / Gmail ─────────────────────────────────

function showCalendarSetup() {
  document.getElementById('calendar-modal').classList.add('show');
  checkGoogleStatus();
}
function closeCalendarModal() { document.getElementById('calendar-modal').classList.remove('show'); }

async function checkGoogleStatus() {
  try {
    const res = await fetch(API + '/oauth/google/status');
    const data = await res.json();

    const connectedEl = document.getElementById('google-connected');
    const notConnectedEl = document.getElementById('google-not-connected');
    const connectBtn = document.getElementById('google-connect-btn');
    const disconnectBtn = document.getElementById('google-disconnect-btn');

    if (data.is_authenticated) {
      connectedEl.style.display = 'block';
      notConnectedEl.style.display = 'none';
      connectBtn.style.display = 'none';
      disconnectBtn.style.display = 'block';
    } else {
      connectedEl.style.display = 'none';
      notConnectedEl.style.display = data.has_credentials ? 'block' : 'none';
      connectBtn.style.display = 'block';
      disconnectBtn.style.display = 'none';

      if (!data.has_credentials) {
        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span style="color:var(--text-muted);font-size:13px;">OAuth not configured</span>';
        connectBtn.title = 'GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET environment variables not set';
      } else {
        connectBtn.disabled = false;
        connectBtn.innerHTML = '<img src="icons/google-signin.png" alt="Sign in with Google" height="40">';
      }
    }
  } catch (e) {
    console.error('Error checking Google status:', e);
  }
}

async function connectGoogle() {
  try {
    const res = await fetch(API + '/oauth/google/start');
    const data = await res.json();

    if (data.success && data.auth_url) {
      window.location.href = data.auth_url;
    } else {
      alert(data.error || 'Failed to start OAuth flow');
    }
  } catch (e) {
    alert('Failed to connect: ' + e.message);
  }
}

async function disconnectGoogle() {
  if (!confirm('Disconnect Google account? You will need to reconnect to use Calendar, Drive, and Gmail features.')) {
    return;
  }

  try {
    const res = await fetch(API + '/oauth/google/disconnect');
    const data = await res.json();

    if (data.success) {
      checkGoogleStatus();
      checkIntegrations();
    } else {
      alert(data.message || 'Failed to disconnect');
    }
  } catch (e) {
    alert('Failed to disconnect: ' + e.message);
  }
}

// Handle OAuth callback results from URL params
function handleOAuthCallback() {
  const params = new URLSearchParams(window.location.search);
  const oauthSuccess = params.get('oauth_success');
  const oauthError = params.get('oauth_error');

  if (oauthSuccess === 'google') {
    window.history.replaceState({}, document.title, window.location.pathname);
    // Go to step 2 (Connect Services) and refresh integrations
    setTimeout(() => {
      goToStep(2);
      checkIntegrations();
    }, 100);
  } else if (oauthError) {
    window.history.replaceState({}, document.title, window.location.pathname);
    alert('Google OAuth failed: ' + oauthError);
  }
}

// Call on page load
document.addEventListener('DOMContentLoaded', handleOAuthCallback);

// ─── Gmail ───────────────────────────────────────────────────────────

function showGmailSetup() {
  document.getElementById('gmail-modal').classList.add('show');
  checkGmailModalStatus();
}
function closeGmailModal() { document.getElementById('gmail-modal').classList.remove('show'); }

async function checkGmailModalStatus() {
  try {
    const res = await fetch(SEARCH_SERVICE + '/gmail/status');
    const data = await res.json();
    const connected = document.getElementById('gmail-connected');
    const notConnected = document.getElementById('gmail-not-connected');
    const connectBtn = document.getElementById('gmail-connect-btn');
    const disconnectBtn = document.getElementById('gmail-disconnect-btn');

    if (data.authenticated && data.isReadOnly) {
      connected.style.display = 'block';
      notConnected.style.display = 'none';
      connectBtn.style.display = 'none';
      disconnectBtn.style.display = 'block';
    } else if (data.authenticated && !data.isReadOnly) {
      connected.style.display = 'none';
      notConnected.style.display = 'block';
      notConnected.querySelector('strong').textContent = 'Re-authentication required';
      notConnected.querySelector('p').textContent = 'Gmail needs to be re-authenticated with read-only access for security.';
      connectBtn.style.display = 'block';
      disconnectBtn.style.display = 'none';
    } else {
      connected.style.display = 'none';
      notConnected.style.display = data.hasOAuthKeys ? 'block' : 'none';
      connectBtn.style.display = 'block';
      disconnectBtn.style.display = 'none';
      if (!data.hasOAuthKeys) {
        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span style="color:var(--text-muted);font-size:13px;">OAuth keys not configured</span>';
      } else if (!data.mcpAvailable) {
        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span style="color:var(--text-muted);font-size:13px;">Gmail MCP not available</span>';
      }
    }
  } catch (e) { console.error('Error checking Gmail status:', e); }
}

async function connectGmailMcp() {
  const btn = document.getElementById('gmail-connect-btn');
  const originalContent = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span style="color:var(--text-muted);">Opening browser...</span>';
  
  try {
    const res = await fetch(SEARCH_SERVICE + '/gmail/auth', { method: 'POST' });
    const data = await res.json();
    
    if (data.alreadyAuthenticated) {
      checkGmailModalStatus();
      checkIntegrations();
      return;
    }
    
    if (data.launched) {
      btn.innerHTML = '<span style="color:var(--text-muted);">Complete login in browser...</span>';
      let attempts = 0;
      const checkAuth = setInterval(async () => {
        attempts++;
        const statusRes = await fetch(SEARCH_SERVICE + '/gmail/status');
        const status = await statusRes.json();
        if (status.authenticated) {
          clearInterval(checkAuth);
          checkGmailModalStatus();
          checkIntegrations();
          await fetch(SEARCH_SERVICE + '/reconnect?mcp=gmail');
        } else if (attempts > 60) {
          clearInterval(checkAuth);
          btn.innerHTML = originalContent;
          btn.disabled = false;
        }
      }, 5000);
    }
  } catch (e) {
    console.error('Gmail auth error:', e);
    btn.innerHTML = originalContent;
    btn.disabled = false;
  }
}

async function disconnectGmailMcp() {
  if (!confirm('This will remove your Gmail credentials. You will need to re-authenticate to use Gmail search.')) {
    return;
  }
  alert('To fully disconnect Gmail, delete the file:\n~/.gmail-mcp/credentials.json\n\nThen restart the search service.');
  checkGmailModalStatus();
  checkIntegrations();
}

// ─── Atlassian ───────────────────────────────────────────────────────

function showAtlassianSetup() {
  document.getElementById('atlassian-modal').classList.add('show');
  checkAtlassianModalStatus();
}
function closeAtlassianModal() { document.getElementById('atlassian-modal').classList.remove('show'); }

async function checkAtlassianModalStatus() {
  try {
    const res = await fetch(API + '/oauth/atlassian/status');
    const data = await res.json();
    const connected = document.getElementById('atlassian-connected');
    const notConnected = document.getElementById('atlassian-not-connected');
    const connectBtn = document.getElementById('atlassian-connect-btn');
    const disconnectBtn = document.getElementById('atlassian-disconnect-btn');

    if (data.authenticated) {
      connected.style.display = 'block';
      notConnected.style.display = 'none';
      connectBtn.style.display = 'none';
      disconnectBtn.style.display = 'block';
    } else {
      connected.style.display = 'none';
      notConnected.style.display = 'block';
      connectBtn.style.display = 'block';
      disconnectBtn.style.display = 'none';
    }
  } catch (e) { console.error('Error checking Atlassian status:', e); }
}

async function connectAtlassian() {
  try {
    const res = await fetch(API + '/oauth/atlassian/start');
    const data = await res.json();
    if (data.success) {
      alert('Atlassian OAuth started. A browser window should open to sign in. After signing in, click "Check Status" to verify.');
    } else {
      alert(data.error || 'Failed to start Atlassian OAuth. Try the manual method below.');
    }
  } catch (e) {
    alert('Failed to connect: ' + e.message);
  }
}

async function disconnectAtlassian() {
  if (!confirm('Disconnect Atlassian? You will need to reconnect to use Jira and Confluence.')) return;
  try {
    const res = await fetch(API + '/oauth/atlassian/disconnect');
    const data = await res.json();
    if (data.success) {
      checkAtlassianModalStatus();
      checkIntegrations();
    } else {
      alert(data.message || 'Failed to disconnect');
    }
  } catch (e) {
    alert('Failed to disconnect: ' + e.message);
  }
}

// ─── Drive ───────────────────────────────────────────────────────────

function showDriveSetup() {
  document.getElementById('drive-modal').classList.add('show');
  checkDriveModalStatus();
}
function closeDriveModal() { document.getElementById('drive-modal').classList.remove('show'); }

async function checkDriveModalStatus() {
  try {
    const res = await fetch(API + '/oauth/google/status');
    const data = await res.json();
    const connected = document.getElementById('drive-connected');
    const notConnected = document.getElementById('drive-not-connected');
    const connectBtn = document.getElementById('drive-connect-btn');
    const disconnectBtn = document.getElementById('drive-disconnect-btn');

    if (data.is_authenticated) {
      connected.style.display = 'block';
      notConnected.style.display = 'none';
      connectBtn.style.display = 'none';
      disconnectBtn.style.display = 'block';
    } else {
      connected.style.display = 'none';
      notConnected.style.display = data.has_credentials ? 'block' : 'none';
      connectBtn.style.display = 'block';
      disconnectBtn.style.display = 'none';
      if (!data.has_credentials) {
        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span style="color:var(--text-muted);font-size:13px;">OAuth not configured</span>';
      }
    }
  } catch (e) { console.error('Error checking Drive status:', e); }
}

// ─── DevsAI ──────────────────────────────────────────────────────────

function showDevsaiSetup() {
  document.getElementById('devsai-modal').classList.add('show');
  checkDevsaiStatus();
}
function closeDevsaiModal() { document.getElementById('devsai-modal').classList.remove('show'); }

async function startDevsaiLogin() {
  const loginResult = document.getElementById('devsai-login-result');
  const loginBtn = document.getElementById('devsai-login-btn');

  if (loginResult) loginResult.textContent = 'Starting login...';
  if (loginBtn) loginBtn.disabled = true;

  try {
    const res = await fetch(SEARCH_SERVICE + '/devsai/login', { method: 'POST' });
    const data = await res.json();

    if (data.alreadyAuthenticated) {
      if (loginResult) loginResult.textContent = 'Already logged in.';
    } else if (data.success) {
      if (loginResult) loginResult.textContent = 'Browser opened. Complete login, then refresh status.';
    } else {
      if (loginResult) loginResult.textContent = data.error || 'Failed to start login.';
    }
  } catch (e) {
    if (loginResult) loginResult.textContent = 'Failed to start login: ' + e.message;
  } finally {
    if (loginBtn) loginBtn.disabled = false;
    setTimeout(checkDevsaiStatus, 1500);
  }
}

async function checkDevsaiStatus() {
  const statusEl = document.getElementById('devsai-status');
  const itemEl = document.getElementById('int-devsai');
  const modalStatus = document.getElementById('devsai-modal-status');
  const configPathEl = document.getElementById('devsai-config-path');
  const loginBtn = document.getElementById('devsai-login-btn');
  const loginResult = document.getElementById('devsai-login-result');

  if (!statusEl || !itemEl) return;

  statusEl.textContent = 'Checking...';
  if (modalStatus) modalStatus.textContent = 'Checking...';
  if (configPathEl) configPathEl.textContent = '';
  if (loginResult) loginResult.textContent = '';

  try {
    const res = await fetch(SEARCH_SERVICE + '/devsai/status');
    const data = await res.json();

    if (!data.installed) {
      statusEl.textContent = 'Not installed';
      if (modalStatus) modalStatus.textContent = 'DevsAI not installed';
      itemEl.classList.remove('configured');
      if (loginBtn) {
        loginBtn.disabled = true;
        loginBtn.textContent = 'Not Installed';
      }
      return;
    }

    if (data.authenticated) {
      statusEl.textContent = 'Connected';
      if (modalStatus) {
        const userLabel = data.userEmail ? 'Logged in as ' + data.userEmail : 'Logged in';
        modalStatus.textContent = userLabel;
      }
      itemEl.classList.add('configured');
      if (loginBtn) {
        loginBtn.disabled = true;
        loginBtn.textContent = 'Logged In';
      }
    } else {
      statusEl.textContent = 'Not logged in';
      if (modalStatus) {
        modalStatus.textContent = data.initError || 'Not logged in';
      }
      itemEl.classList.remove('configured');
      if (loginBtn) {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Start Login';
      }
    }

    if (configPathEl && data.configPath) {
      configPathEl.textContent = 'Config: ' + data.configPath;
    }
  } catch (e) {
    statusEl.textContent = 'Unavailable';
    if (modalStatus) modalStatus.textContent = 'Unable to reach search service';
    itemEl.classList.remove('configured');
    if (loginBtn) {
      loginBtn.disabled = true;
      loginBtn.textContent = 'Start Login';
    }
  }
}

// ─── GitHub ──────────────────────────────────────────────────────────

let githubOAuthPollTimer = null;

async function checkGithubStatus() {
  try {
    const res = await fetch(SEARCH_SERVICE + '/status');
    const data = await res.json();
    for (const srv of (data.servers || [])) {
      if (srv.name === 'github' && srv.status === 'connected') {
        document.getElementById('int-github').classList.add('configured');
        document.getElementById('github-status').textContent = 'Connected';
        return;
      }
    }
  } catch (e) { /* ignore */ }
}

function showGithubSetup() {
  document.getElementById('github-modal').classList.add('show');
  checkGithubModalStatus();
}

function closeGithubModal() {
  document.getElementById('github-modal').classList.remove('show');
  if (githubOAuthPollTimer) { clearTimeout(githubOAuthPollTimer); githubOAuthPollTimer = null; }
}

async function checkGithubModalStatus() {
  const connected = document.getElementById('github-connected');
  const notConnected = document.getElementById('github-not-connected');
  try {
    const res = await fetch(SEARCH_SERVICE + '/status');
    const data = await res.json();
    let ghServer = null;
    for (const srv of (data.servers || [])) {
      if (srv.name === 'github') { ghServer = srv; break; }
    }
    if (ghServer && ghServer.status === 'connected') {
      connected.style.display = 'block';
      notConnected.style.display = 'none';
      document.getElementById('github-oauth-start').style.display = 'none';
      document.getElementById('github-oauth-code').style.display = 'none';
    } else {
      connected.style.display = 'none';
      notConnected.style.display = 'block';
      document.getElementById('github-oauth-start').style.display = 'block';
    }
  } catch (e) {
    connected.style.display = 'none';
    notConnected.style.display = 'block';
    document.getElementById('github-oauth-start').style.display = 'block';
  }
}

function toggleGithubPat() {
  const section = document.getElementById('github-pat-section');
  const arrow = document.getElementById('github-pat-arrow');
  const visible = section.style.display !== 'none';
  section.style.display = visible ? 'none' : 'block';
  arrow.style.transform = visible ? '' : 'rotate(90deg)';
}

function copyDeviceCode() {
  const code = document.getElementById('github-device-code').textContent;
  navigator.clipboard.writeText(code).then(() => {
    const btn = document.getElementById('github-copy-code');
    btn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
    setTimeout(() => {
      btn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';
    }, 2000);
  });
}

async function startGithubOAuth() {
  const btn = document.getElementById('github-oauth-btn');
  const result = document.getElementById('github-modal-result');
  const startSection = document.getElementById('github-oauth-start');
  const codeSection = document.getElementById('github-oauth-code');
  
  btn.disabled = true;
  btn.textContent = 'Starting...';
  result.innerHTML = '';
  
  try {
    const res = await fetch(API + '/setup/github/oauth/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: '{}'
    });
    const data = await res.json();
    
    if (!data.success) {
      result.innerHTML = '<div class="modal-result error">' + (data.error || 'Failed to start OAuth') + '</div>';
      btn.disabled = false;
      btn.textContent = 'Connect with GitHub';
      return;
    }
    
    // Show the device code
    document.getElementById('github-device-code').textContent = data.user_code;
    document.getElementById('github-verify-link').href = data.verification_uri;
    startSection.style.display = 'none';
    codeSection.style.display = 'block';
    
    // Auto-open GitHub in browser
    window.open(data.verification_uri, '_blank');
    
    // Start polling for authorization
    let pollInterval = Math.max((data.interval || 5) + 1, 6) * 1000;
    const expiresAt = Date.now() + (data.expires_in || 900) * 1000;
    
    if (githubOAuthPollTimer) { clearTimeout(githubOAuthPollTimer); githubOAuthPollTimer = null; }
    
    async function pollOAuth() {
      if (Date.now() > expiresAt) {
        codeSection.style.display = 'none';
        startSection.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Connect with GitHub';
        result.innerHTML = '<div class="modal-result error">Code expired. Please try again.</div>';
        return;
      }
      
      try {
        const pollRes = await fetch(API + '/setup/github/oauth/poll', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: '{}'
        });
        const pollData = await pollRes.json();
        
        if (pollData.success && pollData.status === 'complete') {
          githubOAuthPollTimer = null;
          
          codeSection.style.display = 'none';
          result.innerHTML = '<div class="modal-result" style="background:rgba(79,140,255,.1);color:var(--accent-blue)">Authorized! Connecting to GitHub MCP server...</div>';
          
          try { await fetch(SEARCH_SERVICE + '/reconnect?mcp=github'); } catch(e) {}
          
          let connAttempts = 0;
          const connPoll = setInterval(async () => {
            connAttempts++;
            try {
              const statusRes = await fetch(SEARCH_SERVICE + '/status', { signal: AbortSignal.timeout(3000) });
              const statusData = await statusRes.json();
              const ghServer = (statusData.servers || []).find(s => s.name === 'github');
              
              if (ghServer && ghServer.status === 'connected') {
                clearInterval(connPoll);
                result.innerHTML = '<div class="modal-result success">Connected to GitHub (' + ghServer.toolCount + ' tools available)</div>';
                checkGithubModalStatus();
                checkIntegrations();
              } else if (connAttempts >= 20) {
                clearInterval(connPoll);
                result.innerHTML = '<div class="modal-result error">Token saved but MCP connection timed out. Try restarting the search service.</div>';
              } else {
                const msg = ghServer ? 'Connecting...' : 'Restarting search service...';
                result.innerHTML = '<div class="modal-result" style="background:rgba(79,140,255,.1);color:var(--accent-blue)">' + msg + '</div>';
              }
            } catch (e) {
              if (connAttempts < 20) {
                result.innerHTML = '<div class="modal-result" style="background:rgba(79,140,255,.1);color:var(--accent-blue)">Service restarting...</div>';
              }
            }
          }, 2000);
          return;
          
        } else if (pollData.success && pollData.status === 'pending') {
          document.getElementById('github-oauth-status').textContent = 'Waiting for authorization...';
        } else if (pollData.success && pollData.status === 'slow_down') {
          pollInterval = Math.max((pollData.interval || 10) + 1, pollInterval + 5000);
          document.getElementById('github-oauth-status').textContent = 'Waiting for authorization...';
        } else if (!pollData.success) {
          codeSection.style.display = 'none';
          startSection.style.display = 'block';
          btn.disabled = false;
          btn.textContent = 'Connect with GitHub';
          result.innerHTML = '<div class="modal-result error">' + (pollData.error || 'Authorization failed') + '</div>';
          return;
        }
      } catch (e) {
        // Network error, keep trying
      }
      
      githubOAuthPollTimer = setTimeout(pollOAuth, pollInterval);
    }
    
    githubOAuthPollTimer = setTimeout(pollOAuth, pollInterval);
    
  } catch (e) {
    result.innerHTML = '<div class="modal-result error">Failed to start: ' + e.message + '</div>';
    btn.disabled = false;
    btn.textContent = 'Connect with GitHub';
    startSection.style.display = 'block';
    codeSection.style.display = 'none';
  }
}

async function saveGithubPat() {
  const pat = document.getElementById('modal-github-pat').value.trim();
  const result = document.getElementById('github-modal-result');
  const saveBtn = document.querySelector('#github-pat-section .btn-primary');
  
  if (!pat) {
    result.innerHTML = '<div class="modal-result error">Please enter your Personal Access Token</div>';
    return;
  }
  
  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';
  result.innerHTML = '<div class="modal-result" style="background:rgba(79,140,255,.1);color:var(--accent-blue)">Saving token...</div>';
  
  try {
    const res = await fetch(API + '/setup/github', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pat: pat })
    });
    const data = await res.json();
    if (data.success) {
      saveBtn.textContent = 'Connecting...';
      result.innerHTML = '<div class="modal-result" style="background:rgba(79,140,255,.1);color:var(--accent-blue)">Token saved. Connecting...</div>';
      
      try { await fetch(SEARCH_SERVICE + '/reconnect?mcp=github'); } catch(e) {}
      
      let attempts = 0;
      const pollInterval = setInterval(async () => {
        attempts++;
        try {
          const statusRes = await fetch(SEARCH_SERVICE + '/status', { signal: AbortSignal.timeout(3000) });
          const statusData = await statusRes.json();
          const ghServer = (statusData.servers || []).find(s => s.name === 'github');
          
          if (ghServer && ghServer.status === 'connected') {
            clearInterval(pollInterval);
            result.innerHTML = '<div class="modal-result success">Connected to GitHub (' + ghServer.toolCount + ' tools available)</div>';
            saveBtn.textContent = 'Connected';
            checkGithubModalStatus();
            checkIntegrations();
          } else if (attempts >= 20) {
            clearInterval(pollInterval);
            result.innerHTML = '<div class="modal-result error">Connection timed out</div>';
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save & Connect';
          } else {
            result.innerHTML = '<div class="modal-result" style="background:rgba(79,140,255,.1);color:var(--accent-blue)">' + (ghServer ? 'Connecting...' : 'Restarting service...') + '</div>';
          }
        } catch (e) {
          if (attempts < 20) result.innerHTML = '<div class="modal-result" style="background:rgba(79,140,255,.1);color:var(--accent-blue)">Service restarting...</div>';
        }
      }, 2000);
    } else {
      result.innerHTML = '<div class="modal-result error">' + (data.error || 'Failed to save') + '</div>';
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save & Connect';
    }
  } catch (e) {
    result.innerHTML = '<div class="modal-result error">Failed: ' + e.message + '</div>';
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save & Connect';
  }
}

// ─── Legacy status check functions (used by modals) ──────────────────

async function checkCalendarStatus() {
  try {
    const res = await fetch(API + '/hub/status');
    const data = await res.json();
    if (data.calendar?.authenticated) {
      alert('Google Calendar is connected');
      closeCalendarModal();
      checkIntegrations();
    } else {
      alert('Calendar not yet connected. Complete the authentication steps first.');
    }
  } catch (e) {
    alert('Could not check status');
  }
}

async function checkGmailStatus() {
  try {
    const res = await fetch(API + '/hub/status');
    const data = await res.json();
    if (data.gmail?.authenticated) {
      alert('Gmail is connected');
      closeGmailModal();
      checkIntegrations();
    } else {
      alert('Gmail not yet connected. Complete the authentication steps first.');
    }
  } catch (e) {
    alert('Could not check status');
  }
}

async function checkAtlassianStatus() {
  try {
    const res = await fetch(API + '/hub/status');
    const data = await res.json();
    if (data.atlassian?.authenticated) {
      alert('Atlassian is connected');
      closeAtlassianModal();
      checkIntegrations();
    } else {
      alert('Atlassian not yet connected. Run the authentication command first.');
    }
  } catch (e) {
    alert('Could not check status');
  }
}

async function checkDriveStatus() {
  try {
    const res = await fetch(API + '/hub/status');
    const data = await res.json();
    if (data.drive?.authenticated) {
      alert('Google Drive is connected');
      closeDriveModal();
      checkIntegrations();
    } else {
      alert('Drive not yet connected. Run the authentication command first.');
    }
  } catch (e) {
    alert('Could not check status');
  }
}

// ─── Initialize ──────────────────────────────────────────────────────

updateUI();
// Load system info on first step
setTimeout(loadSystemInfo, 600);
</script>
</body>
</html>
