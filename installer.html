<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BriefDesk Setup</title>
<style>
:root {
  --text-primary: rgba(255,255,255,.95);
  --text-secondary: rgba(255,255,255,.75);
  --text-muted: rgba(255,255,255,.5);
  --bg-card: rgba(15,20,35,.65);
  --bg-card-solid: #1a1d2e;
  --border-color: rgba(255,255,255,.12);
  --border-hover: rgba(255,255,255,.22);
  --accent-blue: #4f8cff;
  --accent-green: #34d399;
  --accent-yellow: #fbbf24;
  --accent-red: #f87171;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
  background: #0f1219;
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  color: var(--text-primary);
}
.installer {
  background: var(--bg-card-solid);
  border-radius: 16px;
  border: 1px solid var(--border-color);
  width: 100%;
  max-width: 540px;
  position: relative;
  z-index: 1;
  box-shadow: 0 8px 32px rgba(0,0,0,.3);
}
.header {
  padding: 28px 28px 20px;
  border-bottom: 1px solid var(--border-color);
}
.header-title {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 6px;
}
.header-icon {
  width: 36px;
  height: 36px;
  background: rgba(79,140,255,.15);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.header-icon svg { width: 20px; height: 20px; fill: var(--accent-blue); }
.header h1 {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
}
.header p {
  font-size: 13px;
  color: var(--text-muted);
  margin-left: 48px;
}
.steps-nav {
  display: flex;
  padding: 16px 28px;
  gap: 8px;
  border-bottom: 1px solid var(--border-color);
  background: rgba(0,0,0,.15);
}
.step-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--text-muted);
}
.step-indicator.active { color: var(--text-primary); }
.step-indicator.completed { color: var(--accent-green); }
.step-num {
  width: 22px;
  height: 22px;
  border-radius: 6px;
  background: rgba(255,255,255,.08);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 600;
}
.step-indicator.active .step-num {
  background: var(--accent-blue);
  color: #fff;
}
.step-indicator.completed .step-num {
  background: var(--accent-green);
  color: #fff;
}
.step-indicator.completed .step-num svg { width: 12px; height: 12px; fill: #fff; }
.step-connector {
  width: 20px;
  height: 1px;
  background: var(--border-color);
}
.content {
  padding: 24px 28px;
  min-height: 320px;
}
.step { display: none; }
.step.active { display: block; animation: fadeIn .2s ease; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
h2 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text-primary);
}
.step-desc {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 20px;
  line-height: 1.5;
}
.checklist {
  list-style: none;
}
.check-item {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  background: rgba(255,255,255,.04);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  margin-bottom: 10px;
}
.check-item.checking { background: rgba(251,191,36,.08); border-color: rgba(251,191,36,.2); }
.check-item.success { background: rgba(52,211,153,.08); border-color: rgba(52,211,153,.2); }
.check-item.error { background: rgba(248,113,113,.08); border-color: rgba(248,113,113,.2); }
.check-icon {
  width: 28px;
  height: 28px;
  border-radius: 7px;
  background: rgba(255,255,255,.08);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 14px;
  flex-shrink: 0;
}
.check-icon svg { width: 14px; height: 14px; fill: var(--text-muted); }
.check-item.checking .check-icon { background: rgba(251,191,36,.2); }
.check-item.checking .check-icon svg { fill: var(--accent-yellow); animation: pulse .8s ease infinite; }
.check-item.success .check-icon { background: rgba(52,211,153,.2); }
.check-item.success .check-icon svg { fill: var(--accent-green); }
.check-item.error .check-icon { background: rgba(248,113,113,.2); }
.check-item.error .check-icon svg { fill: var(--accent-red); }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }
.check-info { flex: 1; }
.check-name { font-size: 13px; font-weight: 500; color: var(--text-primary); }
.check-status { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.check-item.success .check-status { color: var(--accent-green); }
.check-item.error .check-status { color: var(--accent-red); }
.help-box {
  background: rgba(79,140,255,.08);
  border: 1px solid rgba(79,140,255,.2);
  border-radius: 10px;
  padding: 14px 16px;
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 16px;
  line-height: 1.5;
}
.help-box code {
  background: rgba(0,0,0,.3);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 11px;
}
.progress-section { margin: 20px 0; }
.progress-bar {
  height: 6px;
  background: rgba(255,255,255,.1);
  border-radius: 3px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: var(--accent-blue);
  border-radius: 3px;
  transition: width .4s ease;
  width: 0%;
}
.progress-label {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 10px;
  text-align: center;
}
.log-box {
  background: rgba(0,0,0,.3);
  border-radius: 8px;
  padding: 12px 14px;
  margin-top: 16px;
  max-height: 120px;
  overflow-y: auto;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 11px;
  color: var(--text-muted);
  line-height: 1.6;
}
.log-box .ok { color: var(--accent-green); }
.log-box .err { color: var(--accent-red); }
.log-box .info { color: var(--accent-blue); }
.integration-item {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  background: rgba(255,255,255,.04);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  margin-bottom: 10px;
  transition: border-color .2s;
}
.integration-item:hover { border-color: var(--border-hover); }
.integration-item.configured { border-color: rgba(52,211,153,.3); background: rgba(52,211,153,.05); }
.integration-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 14px;
  flex-shrink: 0;
  background: rgba(255,255,255,.06);
}
.integration-icon img { width: 26px; height: 26px; object-fit: contain; }
.integration-icon svg { width: 26px; height: 26px; }
.integration-info { flex: 1; }
.integration-name { font-size: 13px; font-weight: 500; color: var(--text-primary); }
.integration-status { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.integration-item.configured .integration-status { color: var(--accent-green); }
.integration-action {
  padding: 7px 14px;
  background: rgba(255,255,255,.08);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-secondary);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all .15s;
}
.integration-action:hover { background: rgba(255,255,255,.12); color: var(--text-primary); }
.skip-link {
  display: block;
  text-align: center;
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 16px;
  cursor: pointer;
}
.skip-link:hover { color: var(--text-secondary); }
.complete-section { text-align: center; padding: 20px 0; }
.complete-icon {
  width: 56px;
  height: 56px;
  background: rgba(52,211,153,.15);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
}
.complete-icon svg { width: 28px; height: 28px; fill: var(--accent-green); }
.complete-url {
  background: rgba(0,0,0,.3);
  border-radius: 8px;
  padding: 14px 18px;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 13px;
  color: var(--accent-blue);
  margin: 16px 0;
}
.footer {
  padding: 16px 28px;
  border-top: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  background: rgba(0,0,0,.1);
}
.btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  border: none;
  transition: all .15s;
  font-family: inherit;
}
.btn-secondary {
  background: rgba(255,255,255,.08);
  color: var(--text-secondary);
  border: 1px solid var(--border-color);
}
.btn-secondary:hover { background: rgba(255,255,255,.12); color: var(--text-primary); }
.btn-primary {
  background: var(--accent-blue);
  color: #fff;
}
.btn-primary:hover { background: #3d7ae8; }
.btn-primary:disabled { background: rgba(255,255,255,.1); color: var(--text-muted); cursor: not-allowed; }
.btn-success { background: var(--accent-green); color: #0f172a; }
.btn-success:hover { background: #2bc48a; }
/* Modal */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 100;
}
.modal.show { display: flex; align-items: center; justify-content: center; }
.modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.6);
  backdrop-filter: blur(4px);
}
.modal-content {
  position: relative;
  background: var(--bg-card-solid);
  border-radius: 12px;
  border: 1px solid var(--border-color);
  padding: 24px;
  max-width: 440px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}
.modal-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}
.modal-header h3 { font-size: 16px; font-weight: 600; }
.modal-close {
  margin-left: auto;
  width: 28px;
  height: 28px;
  background: rgba(255,255,255,.08);
  border: none;
  border-radius: 6px;
  color: var(--text-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.modal-close:hover { background: rgba(255,255,255,.12); color: var(--text-primary); }
.modal-close svg { width: 16px; height: 16px; }
.setup-steps {
  list-style: none;
  counter-reset: step;
}
.setup-steps li {
  counter-increment: step;
  padding: 12px 0 12px 36px;
  position: relative;
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
  border-bottom: 1px solid var(--border-color);
}
.setup-steps li:last-child { border-bottom: none; }
.setup-steps li::before {
  content: counter(step);
  position: absolute;
  left: 0;
  top: 12px;
  width: 22px;
  height: 22px;
  background: rgba(79,140,255,.2);
  color: var(--accent-blue);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 600;
}
.setup-steps code {
  display: block;
  background: rgba(0,0,0,.3);
  padding: 8px 10px;
  border-radius: 6px;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 10px;
  margin-top: 8px;
  overflow-x: auto;
  color: var(--text-muted);
}
.copyable {
  display: flex;
  align-items: stretch;
  margin-top: 8px;
  border-radius: 8px;
  overflow: hidden;
  background: rgba(0,0,0,.4);
  border: 1px solid rgba(255,255,255,.08);
}
.copyable code {
  flex: 1;
  display: block;
  padding: 10px 14px;
  font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
  font-size: 12px;
  color: #a5d6ff;
  word-break: break-all;
  white-space: pre-wrap;
  background: transparent;
  margin: 0;
  overflow-x: auto;
}
.copy-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  padding: 0 12px;
  background: rgba(255,255,255,.06);
  border: none;
  border-left: 1px solid rgba(255,255,255,.1);
  font-size: 11px;
  font-weight: 500;
  color: var(--text-muted);
  cursor: pointer;
  transition: all .15s ease;
  white-space: nowrap;
}
.copy-btn:hover { background: rgba(255,255,255,.12); color: var(--text-primary); }
.copy-btn svg { width: 14px; height: 14px; flex-shrink: 0; }
.copy-btn.copied { background: rgba(52,211,153,.15); color: var(--accent-green); }
.input-group { margin-top: 16px; }
.input-group label {
  display: block;
  font-size: 11px;
  font-weight: 500;
  color: var(--text-muted);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: .5px;
}
.input-group input {
  width: 100%;
  padding: 10px 12px;
  background: rgba(255,255,255,.06);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: 'SF Mono', Monaco, monospace;
}
.input-group input:focus { outline: none; border-color: var(--accent-blue); }
.modal-result {
  margin-top: 12px;
  padding: 10px 12px;
  border-radius: 6px;
  font-size: 12px;
}
.modal-result.success { background: rgba(52,211,153,.1); color: var(--accent-green); }
.modal-result.error { background: rgba(248,113,113,.1); color: var(--accent-red); }
.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.modal-actions .btn { flex: 1; }

/* Server Error Overlay */
.server-error {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,.9);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.server-error-content {
  background: var(--surface);
  border-radius: 12px;
  padding: 32px;
  max-width: 480px;
  text-align: center;
  border: 1px solid var(--border);
}
.server-error-content h3 {
  margin: 16px 0 8px;
  font-size: 20px;
  color: #f59e0b;
}
.server-error-content p {
  color: var(--text-secondary);
  margin: 0;
  font-size: 14px;
}
.server-error-content ul {
  text-align: left;
  margin: 12px 0;
  padding-left: 20px;
  color: var(--text-secondary);
  font-size: 13px;
}
.server-error-content li {
  margin: 6px 0;
}
</style>
</head>
<body>

<div class="installer">
  <div class="header">
    <div class="header-title">
      <div class="header-icon">
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
      </div>
      <h1>BriefDesk Setup</h1>
    </div>
    <p>Configure your productivity dashboard</p>
  </div>
  
  <div class="steps-nav">
    <div class="step-indicator active" data-step="1">
      <div class="step-num">1</div>
      <span>Welcome</span>
    </div>
    <div class="step-connector"></div>
    <div class="step-indicator" data-step="2">
      <div class="step-num">2</div>
      <span>Requirements</span>
    </div>
    <div class="step-connector"></div>
    <div class="step-indicator" data-step="3">
      <div class="step-num">3</div>
      <span>Install</span>
    </div>
    <div class="step-connector"></div>
    <div class="step-indicator" data-step="4">
      <div class="step-num">4</div>
      <span>Permissions</span>
    </div>
    <div class="step-connector"></div>
    <div class="step-indicator" data-step="5">
      <div class="step-num">5</div>
      <span>Connect</span>
    </div>
  </div>
  
  <div class="content">
    <!-- Step 1: Welcome -->
    <div class="step active" id="step-1">
      <h2>Welcome</h2>
      <p class="step-desc">BriefDesk brings your calendar, Slack, email, and productivity tools together in one place. This setup will guide you through the installation.</p>
      
      <ul class="checklist">
        <li class="check-item">
          <div class="check-icon"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>
          <div class="check-info">
            <div class="check-name">Check system requirements</div>
            <div class="check-status">Verify Python and Node.js</div>
          </div>
        </li>
        <li class="check-item">
          <div class="check-icon"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>
          <div class="check-info">
            <div class="check-name">Install BriefDesk</div>
            <div class="check-status">Set up files and background services</div>
          </div>
        </li>
        <li class="check-item">
          <div class="check-icon"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>
          <div class="check-info">
            <div class="check-name">Connect your services</div>
            <div class="check-status">Calendar, Slack, and more</div>
          </div>
        </li>
      </ul>
    </div>
    
    <!-- Step 2: Requirements -->
    <div class="step" id="step-2">
      <h2>System Requirements</h2>
      <p class="step-desc">Checking that your system has the required dependencies.</p>
      
      <ul class="checklist" id="requirements-list">
        <li class="check-item" id="req-python">
          <div class="check-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg></div>
          <div class="check-info">
            <div class="check-name">Python 3</div>
            <div class="check-status">Checking...</div>
          </div>
        </li>
        <li class="check-item" id="req-node">
          <div class="check-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg></div>
          <div class="check-info">
            <div class="check-name">Node.js</div>
            <div class="check-status">Checking...</div>
          </div>
        </li>
      </ul>
      
      <div class="help-box" id="requirements-help" style="display:none;">
        <strong>Missing dependencies?</strong><br>
        Install with Homebrew: <code>brew install python3 node</code><br>
        Or download from python.org and nodejs.org
      </div>
    </div>
    
    <!-- Step 3: Installation -->
    <div class="step" id="step-3">
      <h2>Installing</h2>
      <p class="step-desc">Setting up BriefDesk on your system.</p>
      
      <div class="progress-section">
        <div class="progress-bar">
          <div class="progress-fill" id="install-progress"></div>
        </div>
        <div class="progress-label" id="install-status">Preparing...</div>
      </div>
      
      <div class="log-box" id="install-log"></div>
    </div>
    
    <!-- Step 4: Permissions -->
    <div class="step" id="step-4">
      <h2>Grant Permissions</h2>
      <p class="step-desc">BriefDesk needs Full Disk Access to read your browser history and search Google Drive files.</p>
      
      <ul class="checklist">
        <li class="check-item" id="fda-python">
          <div class="check-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg></div>
          <div class="check-info">
            <div class="check-name">Python (Safari history)</div>
            <div class="check-status" id="fda-python-status">Checking...</div>
          </div>
        </li>
        <li class="check-item" id="fda-node">
          <div class="check-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg></div>
          <div class="check-info">
            <div class="check-name">Node.js (Google Drive)</div>
            <div class="check-status" id="fda-node-status">Checking...</div>
          </div>
        </li>
      </ul>
      
      <div class="help-box">
        <strong>How to grant Full Disk Access:</strong><br><br>
        1. Click "Open System Settings" below<br>
        2. Click the <strong>+</strong> button to add an app<br>
        3. Press <strong>Cmd+Shift+G</strong> and paste one of these Python paths:
        <div class="copyable" style="margin:8px 0 4px;">
          <code id="python-path-primary">/opt/homebrew/bin/python3</code>
          <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
        </div>
        <div style="font-size:11px;color:var(--text-muted);margin:-4px 0 8px 0;">
          Or try: <code style="background:rgba(0,0,0,.2);padding:2px 4px;border-radius:3px">/usr/local/bin/python3</code> or <code style="background:rgba(0,0,0,.2);padding:2px 4px;border-radius:3px">/usr/bin/python3</code>
        </div>
        <div class="copyable" style="margin:4px 0 12px;">
          <code>~/.local/share/devsai/node</code>
          <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
        </div>
        4. Toggle them ON, then click "Check Again"
      </div>
      
      <div style="display:flex;gap:10px;margin-top:16px;">
        <button class="btn btn-secondary" onclick="openFDASettings()" style="flex:1;">Open System Settings</button>
        <button class="btn btn-primary" onclick="checkFDA()" style="flex:1;">Check Again</button>
      </div>
      
      <span class="skip-link" onclick="goToStep(5)">Skip for now (history search may not work)</span>
    </div>
    
    <!-- Step 5: Integrations -->
    <div class="step" id="step-5">
      <h2>Connect Services</h2>
      <p class="step-desc">Configure the integrations you want to use. You can always set these up later from Settings.</p>
      
      <div class="integration-item" id="int-calendar">
        <div class="integration-icon">
          <img src="icons/calendar.png" alt="Google Calendar">
        </div>
        <div class="integration-info">
          <div class="integration-name">Google Calendar</div>
          <div class="integration-status" id="calendar-status">Not configured</div>
        </div>
        <button class="integration-action" onclick="showCalendarSetup()">Setup</button>
      </div>
      
      <div class="integration-item" id="int-slack">
        <div class="integration-icon">
          <img src="icons/slack.png" alt="Slack">
        </div>
        <div class="integration-info">
          <div class="integration-name">Slack</div>
          <div class="integration-status" id="slack-status">Not configured</div>
        </div>
        <button class="integration-action" onclick="showSlackSetup()">Setup</button>
      </div>
      
      <div class="integration-item" id="int-gmail">
        <div class="integration-icon">
          <img src="icons/gmail.png" alt="Gmail">
        </div>
        <div class="integration-info">
          <div class="integration-name">Gmail</div>
          <div class="integration-status" id="gmail-status">Not configured</div>
        </div>
        <button class="integration-action" onclick="showGmailSetup()">Setup</button>
      </div>
      
      <div class="integration-item" id="int-atlassian">
        <div class="integration-icon">
          <img src="icons/jira.svg" alt="Atlassian">
        </div>
        <div class="integration-info">
          <div class="integration-name">Atlassian (Jira & Confluence)</div>
          <div class="integration-status" id="atlassian-status">Not configured</div>
        </div>
        <button class="integration-action" onclick="showAtlassianSetup()">Setup</button>
      </div>
      
      <div class="integration-item" id="int-drive">
        <div class="integration-icon">
          <svg viewBox="0 0 24 24" fill="#4285f4" width="26" height="26"><path d="M7.71 3.5L1.15 15l3.43 6 6.55-11.5L7.71 3.5zm1.14 0l6.57 11.5h6.56l-6.57-11.5H8.85zM8 14.5l-3.43 6h13.71l3.43-6H8z"/></svg>
        </div>
        <div class="integration-info">
          <div class="integration-name">Google Drive</div>
          <div class="integration-status" id="drive-status">Not configured</div>
        </div>
        <button class="integration-action" onclick="showDriveSetup()">Setup</button>
      </div>
      
      <span class="skip-link" onclick="goToStep(6)">Skip for now, configure later</span>
    </div>
    
    <!-- Step 6: Complete -->
    <div class="step" id="step-6">
      <div class="complete-section">
        <div class="complete-icon">
          <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        </div>
        <h2>Setup Complete</h2>
        <p class="step-desc">BriefDesk is installed and running. Set this as your browser homepage for quick access.</p>
        <div class="complete-url">http://127.0.0.1:8765/start.html</div>
        <p class="step-desc" style="font-size:12px;">You can configure more integrations anytime from the Settings panel.</p>
      </div>
    </div>
  </div>
  
  <div class="footer">
    <button class="btn btn-secondary" id="btn-back" onclick="prevStep()" style="visibility:hidden;">Back</button>
    <button class="btn btn-primary" id="btn-next" onclick="nextStep()">Get Started</button>
  </div>
</div>

<!-- Slack Setup Modal -->
<div class="modal" id="slack-modal">
  <div class="modal-backdrop" onclick="closeSlackModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <img src="icons/slack.png" alt="Slack" width="24" height="24">
      <h3>Connect Slack</h3>
      <button class="modal-close" onclick="closeSlackModal()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>
    
    <ol class="setup-steps">
      <li>
        Open <a href="https://app.slack.com" target="_blank" style="color:var(--accent-blue)">app.slack.com</a> in your browser and sign in
      </li>
      <li>
        Open DevTools with <strong>Cmd+Option+I</strong>
      </li>
      <li>
        Go to Application → Cookies → copy the <strong>d</strong> cookie value (XOXD token)
      </li>
      <li>
        In Console tab, paste this to get the XOXC token:
        <div class="copyable">
          <code>JSON.parse(localStorage.getItem('localConfig_v2'))?.teams?.[Object.keys(JSON.parse(localStorage.getItem('localConfig_v2'))?.teams||{})[0]]?.token</code>
          <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
        </div>
      </li>
    </ol>
    
    <div class="input-group">
      <label>XOXC Token</label>
      <input type="text" id="modal-slack-xoxc" placeholder="xoxc-...">
    </div>
    <div class="input-group">
      <label>XOXD Token</label>
      <input type="text" id="modal-slack-xoxd" placeholder="xoxd-...">
    </div>
    
    <div id="slack-modal-result"></div>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeSlackModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSlackTokens()">Save</button>
    </div>
  </div>
</div>

<!-- Calendar Setup Modal -->
<div class="modal" id="calendar-modal">
  <div class="modal-backdrop" onclick="closeCalendarModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <img src="icons/calendar.png" alt="Google Calendar" width="24" height="24">
      <h3>Connect Google Calendar</h3>
      <button class="modal-close" onclick="closeCalendarModal()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>
    
    <ol class="setup-steps">
      <li>
        Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color:var(--accent-blue)">Google Cloud Console</a> and create an OAuth 2.0 Client ID (Desktop app)
      </li>
      <li>
        Enable the <strong>Google Calendar API</strong>:<br>
        <a href="https://console.cloud.google.com/apis/library/calendar-json.googleapis.com" target="_blank" style="color:var(--accent-blue)">Enable Calendar API →</a>
      </li>
      <li>
        Download credentials JSON and save to:
        <div class="copyable">
          <code>~/.local/share/briefdesk/google_credentials.json</code>
          <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
        </div>
      </li>
      <li>
        Run authentication in Terminal:
        <div class="copyable">
          <code>python3 ~/.local/share/briefdesk/search-server.py --auth</code>
          <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
        </div>
      </li>
    </ol>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeCalendarModal()">Close</button>
      <button class="btn btn-primary" onclick="checkCalendarStatus()">Check Status</button>
    </div>
  </div>
</div>

<!-- Gmail Setup Modal -->
<div class="modal" id="gmail-modal">
  <div class="modal-backdrop" onclick="closeGmailModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <img src="icons/gmail.png" alt="Gmail" width="24" height="24">
      <h3>Connect Gmail</h3>
      <button class="modal-close" onclick="closeGmailModal()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>
    
    <ol class="setup-steps">
      <li>
        Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color:var(--accent-blue)">Google Cloud Console</a> and create OAuth credentials (same project as Calendar)
      </li>
      <li>
        Enable the <strong>Gmail API</strong>:<br>
        <a href="https://console.cloud.google.com/apis/library/gmail.googleapis.com" target="_blank" style="color:var(--accent-blue)">Enable Gmail API →</a>
      </li>
      <li>
        Download the credentials JSON, then run this to set it up:
        <div class="copyable">
          <code>mkdir -p ~/.gmail-mcp && mv ~/Downloads/client_secret_*.json ~/.gmail-mcp/gcp-oauth.keys.json</code>
          <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
        </div>
      </li>
      <li>
        Run authentication (opens browser for OAuth):
        <div class="copyable">
          <code>npx @monsoft/mcp-gmail auth</code>
          <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
        </div>
      </li>
    </ol>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeGmailModal()">Close</button>
      <button class="btn btn-primary" onclick="checkGmailStatus()">Check Status</button>
    </div>
  </div>
</div>

<!-- Atlassian Setup Modal -->
<div class="modal" id="atlassian-modal">
  <div class="modal-backdrop" onclick="closeAtlassianModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <img src="icons/jira.svg" alt="Atlassian" width="24" height="24">
      <h3>Connect Atlassian</h3>
      <button class="modal-close" onclick="closeAtlassianModal()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>
    
    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">
      Atlassian uses OAuth authentication. Running this command will open your browser to sign in.
    </p>
    
    <ol class="setup-steps">
      <li>
        Run authentication in Terminal (opens browser):
        <div class="copyable">
          <code>npx -y mcp-remote https://mcp.atlassian.com/v1/sse</code>
          <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
        </div>
      </li>
      <li>
        Sign in with your Atlassian account and authorize access
      </li>
      <li>
        OAuth tokens are cached automatically for future use
      </li>
    </ol>
    
    <p style="color:var(--text-muted);font-size:11px;margin-top:16px;">
      Note: You may need to re-authenticate after ~30 days when tokens expire.
    </p>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeAtlassianModal()">Close</button>
      <button class="btn btn-primary" onclick="checkAtlassianStatus()">Check Status</button>
    </div>
  </div>
</div>

<!-- Drive Setup Modal -->
<div class="modal" id="drive-modal">
  <div class="modal-backdrop" onclick="closeDriveModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <svg viewBox="0 0 24 24" fill="#4285f4" width="24" height="24"><path d="M7.71 3.5L1.15 15l3.43 6 6.55-11.5L7.71 3.5zm1.14 0l6.57 11.5h6.56l-6.57-11.5H8.85zM8 14.5l-3.43 6h13.71l3.43-6H8z"/></svg>
      <h3>Connect Google Drive</h3>
      <button class="modal-close" onclick="closeDriveModal()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    </div>
    
    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">
      Uses the same Google Cloud project as Calendar. Just needs Drive API enabled and a quick auth.
    </p>
    
    <ol class="setup-steps">
      <li>
        Enable the <strong>Google Drive API</strong>:<br>
        <a href="https://console.cloud.google.com/apis/library/drive.googleapis.com" target="_blank" style="color:var(--accent-blue)">Enable Drive API →</a>
      </li>
      <li>
        <em>(Optional)</em> Enable these for better content reading:<br>
        <a href="https://console.cloud.google.com/apis/library/sheets.googleapis.com" target="_blank" style="color:var(--accent-blue);margin-right:12px">Sheets API</a>
        <a href="https://console.cloud.google.com/apis/library/docs.googleapis.com" target="_blank" style="color:var(--accent-blue)">Docs API</a>
      </li>
      <li>
        Run authentication in Terminal (opens browser):
        <div class="copyable">
          <code>cd ~/.local/share/briefdesk/gdrive-mcp && npm run auth</code>
          <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
        </div>
      </li>
      <li>
        Sign in and authorize <strong>drive.readonly</strong> access
      </li>
    </ol>
    
    <p style="color:var(--text-muted);font-size:11px;margin-top:16px;">
      Note: Uses read-only access. BriefDesk can search and read your files but cannot modify them.
    </p>
    
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeDriveModal()">Close</button>
      <button class="btn btn-primary" onclick="checkDriveStatus()">Check Status</button>
    </div>
  </div>
</div>

<!-- Server Error Overlay -->
<div id="server-error" class="server-error" style="display:none;">
  <div class="server-error-content">
    <svg viewBox="0 0 24 24" width="48" height="48" fill="#f59e0b"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
    <h3>Server Not Running</h3>
    <p>The BriefDesk server isn't responding. This can happen if:</p>
    <ul>
      <li>The server hasn't started yet (wait a few seconds)</li>
      <li>The server crashed or was stopped</li>
      <li>Another app is using port 18765</li>
    </ul>
    <p style="margin-top:16px;font-size:12px;color:var(--text-muted);">Try restarting the server manually:</p>
    <div class="copyable" style="margin:8px 0;">
      <code>launchctl kickstart -k gui/$(id -u)/com.briefdesk.server</code>
      <button class="copy-btn" onclick="copyText(this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy</button>
    </div>
    <button class="btn btn-primary" onclick="checkServerConnection()" style="margin-top:16px;">Retry Connection</button>
  </div>
</div>

<script>
const API = 'http://127.0.0.1:18765';
let currentStep = 1;
let requirementsOk = false;
let installComplete = false;
let serverConnected = false;

// Check server connection on load
async function checkServerConnection() {
  const errorEl = document.getElementById('server-error');
  try {
    const res = await fetch(API + '/hub/status', { signal: AbortSignal.timeout(5000) });
    if (res.ok) {
      serverConnected = true;
      errorEl.style.display = 'none';
      return true;
    }
  } catch (e) {
    console.error('Server connection failed:', e);
  }
  serverConnected = false;
  errorEl.style.display = 'flex';
  return false;
}

// Check on page load
setTimeout(checkServerConnection, 500);

function copyText(btn) {
  const code = btn.parentElement.querySelector('code');
  const text = code.textContent;
  navigator.clipboard.writeText(text).then(() => {
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Copied';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy';
      btn.classList.remove('copied');
    }, 2000);
  });
}

function updateUI() {
  // Update step indicators
  document.querySelectorAll('.step-indicator').forEach((el, i) => {
    el.classList.remove('active', 'completed');
    const step = i + 1;
    if (step === currentStep) el.classList.add('active');
    else if (step < currentStep) {
      el.classList.add('completed');
      el.querySelector('.step-num').innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
    }
  });
  
  // Update step content
  document.querySelectorAll('.step').forEach((el, i) => {
    el.classList.toggle('active', i + 1 === currentStep);
  });
  
  // Update buttons
  document.getElementById('btn-back').style.visibility = currentStep > 1 ? 'visible' : 'hidden';
  const nextBtn = document.getElementById('btn-next');
  
  if (currentStep === 1) {
    nextBtn.textContent = 'Get Started';
    nextBtn.disabled = false;
    nextBtn.className = 'btn btn-primary';
  } else if (currentStep === 2) {
    nextBtn.textContent = 'Continue';
    nextBtn.disabled = !requirementsOk;
    nextBtn.className = 'btn btn-primary';
  } else if (currentStep === 3) {
    nextBtn.textContent = 'Continue';
    nextBtn.disabled = !installComplete;
    nextBtn.className = 'btn btn-primary';
  } else if (currentStep === 4) {
    nextBtn.textContent = 'Continue';
    nextBtn.disabled = false;
    nextBtn.className = 'btn btn-primary';
  } else if (currentStep === 5) {
    nextBtn.textContent = 'Finish';
    nextBtn.disabled = false;
    nextBtn.className = 'btn btn-primary';
  } else if (currentStep === 6) {
    nextBtn.textContent = 'Open BriefDesk';
    nextBtn.disabled = false;
    nextBtn.className = 'btn btn-success';
  }
}

function goToStep(step) {
  currentStep = step;
  updateUI();
  if (step === 2) checkRequirements();
  if (step === 3) runInstallation();
  if (step === 4) checkFDA();
  if (step === 5) checkIntegrations();
}

function nextStep() {
  if (currentStep === 6) {
    window.open('http://127.0.0.1:8765/start.html', '_blank');
    return;
  }
  goToStep(currentStep + 1);
}

function prevStep() {
  if (currentStep > 1) goToStep(currentStep - 1);
}

async function checkRequirements() {
  const checks = [
    { id: 'req-python', cmd: 'python3 --version' },
    { id: 'req-node', cmd: 'node --version' }
  ];
  
  let allOk = true;
  
  for (const check of checks) {
    const el = document.getElementById(check.id);
    const icon = el.querySelector('.check-icon');
    const status = el.querySelector('.check-status');
    
    el.className = 'check-item checking';
    icon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg>';
    status.textContent = 'Checking...';
    
    await new Promise(r => setTimeout(r, 400));
    
    try {
      const res = await fetch(API + '/installer/check?cmd=' + encodeURIComponent(check.cmd));
      const data = await res.json();
      
      if (data.ok) {
        el.className = 'check-item success';
        icon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
        status.textContent = data.version || 'Installed';
      } else {
        throw new Error('Not found');
      }
    } catch (e) {
      el.className = 'check-item error';
      icon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>';
      status.textContent = 'Not installed';
      allOk = false;
    }
  }
  
  requirementsOk = allOk;
  document.getElementById('requirements-help').style.display = allOk ? 'none' : 'block';
  updateUI();
}

async function runInstallation() {
  const progress = document.getElementById('install-progress');
  const status = document.getElementById('install-status');
  const log = document.getElementById('install-log');
  
  const steps = [
    { msg: 'Creating directories...', pct: 15 },
    { msg: 'Copying files...', pct: 35 },
    { msg: 'Setting up services...', pct: 60 },
    { msg: 'Starting background processes...', pct: 80 },
    { msg: 'Verifying installation...', pct: 95 }
  ];
  
  log.innerHTML = '';
  
  for (const step of steps) {
    status.textContent = step.msg;
    progress.style.width = step.pct + '%';
    log.innerHTML += `<span class="info">› ${step.msg}</span>\n`;
    log.scrollTop = log.scrollHeight;
    await new Promise(r => setTimeout(r, 300));
  }
  
  try {
    const res = await fetch(API + '/installer/install', { method: 'POST' });
    const data = await res.json();
    
    if (data.success) {
      progress.style.width = '100%';
      status.textContent = 'Installation complete';
      log.innerHTML += '<span class="ok">✓ Done</span>\n';
      installComplete = true;
    } else {
      throw new Error(data.error || 'Installation failed');
    }
  } catch (e) {
    log.innerHTML += `<span class="err">✗ ${e.message}</span>\n`;
    status.textContent = 'Error: ' + e.message;
  }
  
  updateUI();
}

async function checkIntegrations() {
  try {
    const res = await fetch(API + '/hub/status');
    const data = await res.json();
    
    if (data.calendar?.authenticated) {
      document.getElementById('int-calendar').classList.add('configured');
      document.getElementById('calendar-status').textContent = 'Connected';
    }
    
    if (data.slack?.authenticated) {
      document.getElementById('int-slack').classList.add('configured');
      document.getElementById('slack-status').textContent = 'Connected';
    }
    
    if (data.gmail?.authenticated) {
      document.getElementById('int-gmail').classList.add('configured');
      document.getElementById('gmail-status').textContent = 'Connected';
    }
    
    if (data.atlassian?.authenticated) {
      document.getElementById('int-atlassian').classList.add('configured');
      document.getElementById('atlassian-status').textContent = 'Connected';
    }
    
    if (data.drive?.authenticated) {
      document.getElementById('int-drive').classList.add('configured');
      document.getElementById('drive-status').textContent = 'Connected';
    }
  } catch (e) {
    console.error('Failed to check integrations:', e);
  }
}

async function checkFDA() {
  // Check if FDA is granted by trying to read Safari history
  const checks = [
    { id: 'fda-python', name: 'Python', statusId: 'fda-python-status' },
    { id: 'fda-node', name: 'Node.js', statusId: 'fda-node-status' }
  ];
  
  for (const check of checks) {
    const el = document.getElementById(check.id);
    const status = document.getElementById(check.statusId);
    const icon = el.querySelector('.check-icon');
    
    el.className = 'check-item checking';
    icon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg>';
    status.textContent = 'Checking...';
  }
  
  await new Promise(r => setTimeout(r, 500));
  
  try {
    // Test FDA by doing a search - if it works, FDA is granted
    const res = await fetch(API + '/installer/check-fda');
    const data = await res.json();
    
    // Python FDA check
    const pythonEl = document.getElementById('fda-python');
    const pythonStatus = document.getElementById('fda-python-status');
    const pythonIcon = pythonEl.querySelector('.check-icon');
    
    if (data.python_fda) {
      pythonEl.className = 'check-item success';
      pythonIcon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
      pythonStatus.textContent = 'Access granted';
    } else {
      pythonEl.className = 'check-item error';
      pythonIcon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>';
      pythonStatus.textContent = 'Not granted - add to Full Disk Access';
    }
    
    // Node FDA check (optional, only if devsai is installed)
    const nodeEl = document.getElementById('fda-node');
    const nodeStatus = document.getElementById('fda-node-status');
    const nodeIcon = nodeEl.querySelector('.check-icon');
    
    if (data.node_fda === true) {
      nodeEl.className = 'check-item success';
      nodeIcon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
      nodeStatus.textContent = 'Access granted';
    } else if (data.node_fda === 'not_installed') {
      nodeEl.className = 'check-item';
      nodeIcon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg>';
      nodeStatus.textContent = 'Optional - for Google Drive search';
    } else {
      nodeEl.className = 'check-item error';
      nodeIcon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>';
      nodeStatus.textContent = 'Not granted - add to Full Disk Access';
    }
    
    // Update the Python path in instructions if server provided it
    if (data.python_path) {
      const pathEl = document.getElementById('python-path-primary');
      if (pathEl) pathEl.textContent = data.python_path;
    }
  } catch (e) {
    console.error('FDA check failed:', e);
    // Show as needing setup
    document.getElementById('fda-python').className = 'check-item';
    document.getElementById('fda-python-status').textContent = 'Unable to check - grant access manually';
    document.getElementById('fda-node').className = 'check-item';
    document.getElementById('fda-node-status').textContent = 'Optional - for Google Drive search';
  }
}

function openFDASettings() {
  // Open System Settings to Privacy & Security > Full Disk Access
  // This uses a URL scheme that works on macOS Ventura+
  window.open('x-apple.systempreferences:com.apple.preference.security?Privacy_AllFiles');
}

function showSlackSetup() { document.getElementById('slack-modal').classList.add('show'); }
function closeSlackModal() { document.getElementById('slack-modal').classList.remove('show'); }
function showCalendarSetup() { document.getElementById('calendar-modal').classList.add('show'); }
function closeCalendarModal() { document.getElementById('calendar-modal').classList.remove('show'); }
function showGmailSetup() { document.getElementById('gmail-modal').classList.add('show'); }
function closeGmailModal() { document.getElementById('gmail-modal').classList.remove('show'); }
function showAtlassianSetup() { document.getElementById('atlassian-modal').classList.add('show'); }
function closeAtlassianModal() { document.getElementById('atlassian-modal').classList.remove('show'); }
function showDriveSetup() { document.getElementById('drive-modal').classList.add('show'); }
function closeDriveModal() { document.getElementById('drive-modal').classList.remove('show'); }

async function saveSlackTokens() {
  const xoxc = document.getElementById('modal-slack-xoxc').value.trim();
  const xoxd = document.getElementById('modal-slack-xoxd').value.trim();
  const result = document.getElementById('slack-modal-result');
  
  if (!xoxc || !xoxd) {
    result.innerHTML = '<div class="modal-result error">Please enter both tokens</div>';
    return;
  }
  
  result.innerHTML = '<div class="modal-result" style="background:rgba(79,140,255,.1);color:var(--accent-blue)">Saving...</div>';
  
  try {
    const res = await fetch(API + '/setup/slack', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ xoxc, xoxd })
    });
    const data = await res.json();
    
    if (data.success) {
      result.innerHTML = '<div class="modal-result success">Connected successfully</div>';
      setTimeout(() => { closeSlackModal(); checkIntegrations(); }, 1000);
    } else {
      result.innerHTML = `<div class="modal-result error">${data.error || 'Failed to connect'}</div>`;
    }
  } catch (e) {
    result.innerHTML = '<div class="modal-result error">Connection failed</div>';
  }
}

async function checkCalendarStatus() {
  try {
    const res = await fetch(API + '/hub/status');
    const data = await res.json();
    if (data.calendar?.authenticated) {
      alert('Google Calendar is connected');
      closeCalendarModal();
      checkIntegrations();
    } else {
      alert('Calendar not yet connected. Complete the authentication steps first.');
    }
  } catch (e) {
    alert('Could not check status');
  }
}

async function checkGmailStatus() {
  try {
    const res = await fetch(API + '/hub/status');
    const data = await res.json();
    if (data.gmail?.authenticated) {
      alert('Gmail is connected');
      closeGmailModal();
      checkIntegrations();
    } else {
      alert('Gmail not yet connected. Complete the authentication steps first.');
    }
  } catch (e) {
    alert('Could not check status');
  }
}

async function checkAtlassianStatus() {
  try {
    const res = await fetch(API + '/hub/status');
    const data = await res.json();
    if (data.atlassian?.authenticated) {
      alert('Atlassian is connected');
      closeAtlassianModal();
      checkIntegrations();
    } else {
      alert('Atlassian not yet connected. Run the authentication command first.');
    }
  } catch (e) {
    alert('Could not check status');
  }
}

async function checkDriveStatus() {
  try {
    const res = await fetch(API + '/hub/status');
    const data = await res.json();
    if (data.drive?.authenticated) {
      alert('Google Drive is connected');
      closeDriveModal();
      checkIntegrations();
    } else {
      alert('Drive not yet connected. Run the authentication command first.');
    }
  } catch (e) {
    alert('Could not check status');
  }
}

updateUI();
</script>
</body>
</html>
